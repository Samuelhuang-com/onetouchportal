{% extends "base.html" %}
{% block title %}ç°½æ ¸è©³æƒ… - {{ approval.subject }} Â· {{ super() if super else 'OneTouch' }}{% endblock %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
<style>
  .wrap{max-width:1100px;margin:auto;padding:12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin-bottom:12px}
  .muted{color:#6b7280}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 260px}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid #ddd;font-size:12px}
  .ok{background:#ecfdf5}
  .warn{background:#fffbeb}
  .danger{background:#fee2e2}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
  .btn{border:1px solid #2563eb;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff}
  textarea,input[type="text"],select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  .ql-editor.readonly{padding:0}

  /* å…§å®¹æ¡†ç·Šæ¹Š */
  .content-box { border:1px solid #ddd;border-radius:8px;padding:6px;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.12); }
  .content-box .ql-snow{ padding:0;border:0;background:transparent; }
  .content-box .ql-editor{ padding:0;min-height:unset;line-height:1.45; }
  .content-box .ql-editor p{ margin:.25em 0; }

  /* æœå°‹ Modalï¼ˆæ²¿ç”¨ new.html é¢¨æ ¼ï¼‰ */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{width:min(1100px,92vw);max-height:86vh;overflow:hidden;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.18);display:flex;flex-direction:column}
  .modal-header{padding:12px 14px;border-bottom:1px solid #e5e7eb;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .modal-title{font-weight:700}
  .modal-body{padding:12px 14px;overflow:auto}
  .modal-footer{border-top:1px solid #e5e7eb;padding:10px 14px;display:flex;justify-content:flex-end;gap:8px}
  .searchbar{display:flex;gap:8px;align-items:center;width:100%}
  .searchbar input[type="search"]{flex:1;padding:10px;border-radius:10px;border:1px solid #e5e7eb;font-size:14px}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px;min-width:900px}
  .rowr{background:#fff;border:1px solid #e5e7eb;border-radius:10px}
  .rowr td{padding:8px;border-bottom:1px dashed #eee;font-size:14px}
  .rowr td:last-child{border-bottom:0}
  .btn.sm{padding:6px 10px;font-size:12px;border-radius:8px}

  /* å¯æ‹–æ‹‰åˆ—çš„æ¸¸æ¨™æç¤º */
  tr.draggable { cursor: grab; }
</style>

<div class="wrap">

  {% if can_act %}
    <div class="card" style="border-color:#86efac;background:#f0fdf4">âœ… ä½ æ˜¯ <strong>#{{ approval.current_step + 1 }}</strong> é—œçš„ç°½æ ¸äººï¼Œè«‹å®Œæˆç°½æ ¸ã€‚</div>
  {% elif approval.status == 'pending' and approval.current_step >= 0 and current_step_obj %}
    <div class="card" style="border-color:#fde68a;background:#fffbeb">â³ ç›®å‰ç°½æ ¸äººï¼š<strong>{{ current_step_obj.approver_name }}</strong>ï¼ˆç¬¬ #{{ approval.current_step + 1 }} é—œï¼‰</div>
  {% endif %}
  {% if request.query_params.get('error') == 'comment_required' %}
    <div class="card" style="border-color:#fecaca;background:#fef2f2;color:#991b1b">âš ï¸ ç°½æ ¸æ„è¦‹ç‚ºå¿…å¡«ï¼Œè«‹å¡«å¯«å¾Œå†é€å‡ºã€‚</div>
  {% endif %}

  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
  <h2>ğŸ“„ {{ approval.subject }}</h2>
      <div style="display:flex;gap:8px;align-items:center">
        {% if role == 'admin' %}
          <button class="btn" id="btnBuildIdx" title="ä¿®å¾©åºè™Ÿä¸¦å»ºç«‹å”¯ä¸€ç´¢å¼•">ğŸ›  ä¸€éµä¿®å¾©/å»ºç«‹ç´¢å¼•</button>
          <button class="btn" id="btnBuildEmpIdx" title="å»ºç«‹å“¡å·¥æœå°‹ç´¢å¼•">ğŸ›  å“¡å·¥ç´¢å¼•</button>
        {% endif %}
        {% if approval.status == 'approved' %}
          <span class="badge ok">å®Œæˆ</span>
        {% elif approval.status == 'rejected' %}
          <span class="badge warn">é€€å›</span>
        {% else %}
          <span class="badge" style="color:#2563eb">é€²è¡Œä¸­</span>
        {% endif %}
      </div>
    </div>

    </div>
    <div class="row">
      <div class="col"><strong>é€ç°½äººï¼š</strong>{{ approval.requester }}</div>
      <div class="col"><strong>é€ç°½éƒ¨é–€ï¼š</strong>{{ approval.requester_dept or '-' }}</div>
      <div class="col"><strong>é€ç°½æ™‚é–“ï¼š</strong><span class="muted">{{ approval.submitted_at }}</span></div>
      <div class="col" style="color:#2563eb"><strong>ç›®å‰é—œå¡ï¼š</strong>{% if approval.current_step>=0 %}#{{ approval.current_step + 1 }}{% else %}-{% endif %}</div>
    </div>

    <strong>å…§å®¹ï¼š</strong>
    <div class="content-box" style="margin-top:6px">
      <div class="ql-snow">
        <div class="ql-editor readonly">{{ (approval.description|trim)|safe if approval.description else 'ï¼ˆç„¡ï¼‰' }}</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“ é™„ä»¶</h3>
    {% if attachments and attachments|length>0 %}
      <table>
        <thead><tr><th>æª”å</th><th>å¤§å°</th><th>ä¸Šå‚³è€…</th><th>æ™‚é–“</th><th></th></tr></thead>
        <tbody>
        {% for f in attachments %}
        <tr>
          <td>{{ f.name }}</td>
          <td class="muted">{{ (f.size/1024/1024)|round(2) }} MB</td>
          <td>{{ f.by or '-' }}</td>
          <td class="muted">{{ f.at }}</td>
          <td><a class="btn" href="/approvals/{{ approval.id }}/file/{{ f.id }}">ä¸‹è¼‰</a></td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">ç„¡é™„ä»¶ã€‚</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>ğŸ§­ ä¸²ç°½æµç¨‹</h3>

    {% if can_manage_chain %}
      <!-- è·Ÿ new.html ä¸€è‡´çš„ã€Œé¸éƒ¨é–€â†’é¸äººå“¡â†’åŠ å…¥ / è·¨å€æœå°‹ã€ -->
      <div class="row" style="margin:8px 0 12px">
        <div class="col">
          <label>é¸æ“‡éƒ¨é–€</label>
          <select id="dept">
            <option value="">-- é¸æ“‡éƒ¨é–€ --</option>
            {% for d in departments %}
            <option value="{{ d }}">{{ d }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col">
          <label>é¸æ“‡äººå“¡</label>
          <select id="person">
            <option value="">è«‹å…ˆé¸éƒ¨é–€</option>
          </select>
        </div>
        <div class="col" style="align-self:flex-end;display:flex;gap:8px;flex-wrap:wrap">
          <button type="button" class="btn" id="btnAddPick">â• åŠ å…¥</button>
          <button type="button" class="btn" id="openSearchBtn">ğŸ” è·¨å€æœå°‹</button>
        </div>
      </div>
    {% endif %}

    <table>
      <thead>
        <tr><th style="width:70px">é—œå¡</th><th>ç°½æ ¸äºº</th><th style="width:130px">ç‹€æ…‹</th><th style="width:170px">è™•ç†æ™‚é–“</th><th>æ„è¦‹</th></tr>
      </thead>
      <tbody id="stepsTbody">
        {% for s in steps %}
        <tr
          data-step-id="{{ s.id }}"
          data-step-order="{{ s.step_order }}"
          data-pending="{{ 1 if s.status=='pending' else 0 }}"
          draggable="{% if s.status=='pending' and s.step_order>approval.current_step and can_manage_chain %}true{% else %}false{% endif %}"
          class="{% if s.status=='pending' and s.step_order>approval.current_step and can_manage_chain %}draggable{% endif %}"
          {% if approval.current_step == s.step_order and s.status=='pending' %}style="background:#f9fafb"{% endif %}
        >
          <td>#{{ s.step_order + 1 }}</td>
          <td>
            {% if s.status=='pending' and s.step_order>approval.current_step and can_manage_chain %}
              <span style="cursor:grab;margin-right:6px">â ¿</span>
            {% endif %}
            {{ s.approver_name }}
            <div class="muted">{{ s.approver_email or '' }}</div>
          </td>
          <td>
            {% if s.status == 'approved' %}<span class="badge ok">åŒæ„</span>
            {% elif s.status == 'rejected' %}<span class="badge danger">é€€å›</span>
            {% else %}<span class="badge">å¾…ç°½</span>{% endif %}
          </td>
          <td class="muted">{{ s.decided_at or '' }}</td>
          <td style="white-space:pre-wrap">{{ s.comment or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if can_act %}
      <form method="post" action="/approvals/{{ approval.id }}/action" style="margin-top:16px">
        <label>ç°½æ ¸æ„è¦‹ï¼ˆå¿…å¡«ï¼‰</label>
        <textarea id="comment" name="comment" rows="4" placeholder="è¼¸å…¥çµ¦ç”³è«‹äººæˆ–ä¸‹ä¸€é—œçš„è¨Šæ¯â€¦"></textarea>
        <input type="hidden" name="action" id="actField" value="approve">
        <div style="margin-top:10px;display:flex;gap:10px">
          <button class="btn primary" onclick="document.getElementById('actField').value='approve'">âœ… åŒæ„</button>
          <button class="btn" onclick="document.getElementById('actField').value='reject'">â†©ï¸ é€€å›</button>
          <a href="/approvals" class="btn">è¿”å›æ¸…å–®</a>
        </div>
        <p class="muted" style="margin-top:6px">ä½ æ˜¯æ­¤å–®ç›®å‰é—œå¡çš„ç°½æ ¸äººï¼Œè™•ç†å¾Œç³»çµ±æœƒè‡ªå‹•é€šçŸ¥ä¸‹ä¸€é—œæˆ–ç”³è«‹äººã€‚</p>
      </form>
    {% else %}
      <div style="margin-top:10px">
        <a href="/approvals" class="btn">è¿”å›æ¸…å–®</a>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <h3>ğŸ—‚ï¸ æ­·ç¨‹</h3>
    {% if actions and actions|length>0 %}
      <table>
        <thead><tr><th style="width:160px">æ™‚é–“</th><th style="width:140px">å‹•ä½œè€…</th><th style="width:100px">å‹•ä½œ</th><th>å…§å®¹</th></tr></thead>
        <tbody>
          {% for a in actions %}
          <tr>
            <td class="muted">{{ a.created_at }}</td>
            <td>{{ a.actor }}</td>
            <td>{{ 'é€å‡º' if a.action=='submit' else ('åŒæ„' if a.action=='approve' else ('é€€å›' if a.action=='reject' else a.action)) }}</td>
            <td style="white-space:pre-wrap">{{ a.note or '' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">å°šç„¡æ­·ç¨‹ã€‚</p>
    {% endif %}
  </div>
</div>

<script>
(function(){
  const canManage = {{ 'true' if can_manage_chain else 'false' }};
  const approvalId = {{ approval.id }};
  const curStep = {{ approval.current_step if approval.current_step is not none else -1 }};

  // === A) é¸éƒ¨é–€ â†’ è¼‰äººå“¡ ===
  if (canManage){
    const $ = (id)=>document.getElementById(id);
    const deptEl = $("dept"), personEl = $("person");

    deptEl?.addEventListener("change", async (e)=>{
      const d = e.target.value;
      personEl.innerHTML = `<option value="">${d ? "è¼‰å…¥ä¸­â€¦" : "è«‹å…ˆé¸éƒ¨é–€"}</option>`;
      if(!d) return;
      const res = await fetch(`/approvals/approvers?dept=${encodeURIComponent(d)}`);
      const data = await res.json();
      personEl.innerHTML = `<option value="">-- é¸æ“‡äººå“¡ --</option>`;
      (data.names||[]).forEach((n)=>{
        const op = document.createElement("option");
        op.value = n; op.textContent = n;
        personEl.appendChild(op);
      });
    });

    // === B) ç”±ä¸‹æ‹‰åŠ å…¥ ===
    $("btnAddPick")?.addEventListener("click", async ()=>{
      const name = (personEl?.value || "").trim();
      if(!name){ alert("è«‹å…ˆé¸æ“‡äººå“¡"); return; }
      const fd = new FormData(); fd.append("display_name", name);
      const res = await fetch(`/approvals/${approvalId}/steps/add`, {method:"POST", body:fd});
      const j = await res.json();
      if(!j.ok){ alert("åŠ å…¥å¤±æ•—ï¼š" + (j.error||res.status)); return; }
      location.reload();
    });

    // === C) è·¨å€æœå°‹ Modal ===
    const HEADERS = ["Department","Department_1","EnglishName","Name","Email","Ext","Pick"];
    function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
    function rowToLabel(r){
      const en=(r.EnglishName||"").trim(), nm=(r.Name||"").trim();
      return en&&nm ? `${en} ${nm}` : (en||nm);
    }
    const modalHTML = `
      <div class="modal-backdrop" id="searchModal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <div class="modal-header">
            <div class="searchbar">
              <strong class="modal-title" id="modalTitle">ğŸ” ç°½æ ¸äººå“¡è·¨å€æœå°‹</strong>
              <input id="q" type="search" placeholder="è¼¸å…¥é—œéµå­—â€¦" />
              <button class="btn primary" id="btnRecent" type="button">æœ€è¿‘50ç­†</button>
            </div>
            <button class="btn primary" id="closeModal" type="button">âœ–</button>
          </div>
          <div class="modal-body">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <span class="pill" style="border:1px solid #d1d5db;border-radius:8px;padding:6px 10px">ç­†æ•¸ <strong id="counter" style="margin-left:6px">0</strong></span>
            </div>
            <div class="table-wrap" style="overflow:auto">
              <table class="table">
                <thead id="thead"></thead>
                <tbody id="list"></tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" id="closeModal2" type="button">é—œé–‰</button>
          </div>
        </div>
      </div>`;
    document.body.insertAdjacentHTML("beforeend", modalHTML);

    const $$ = (id)=>document.getElementById(id);
    function renderHeader(){ $$("#thead").innerHTML = `<tr>${HEADERS.map(h=>`<th style="text-align:left;padding:6px 8px">${esc(h)}</th>`).join("")}</tr>`; }
    function renderList(rows){
      const tb=$$("#list"); tb.innerHTML=""; $$("#counter").textContent = rows.length;
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        tr.className="rowr";
        tr.innerHTML = `
          <td>${esc(r.Department||"")}</td>
          <td>${esc(r.Department_1||"")}</td>
          <td>${esc(r.EnglishName||"")}</td>
          <td>${esc(r.Name||"")}</td>
          <td>${esc(r.Email||"")}</td>
          <td>${esc(r.Ext||"")}</td>
          <td><button class="btn primary sm" type="button">â• åŠ å…¥</button></td>`;
        tr.querySelector("button").addEventListener("click", async ()=>{
          const label = rowToLabel(r); if(!label) return;
          const fd=new FormData(); fd.append("display_name", label);
          const res = await fetch(`/approvals/${approvalId}/steps/add`, {method:"POST", body:fd});
          const j = await res.json();
          if(!j.ok){ alert("åŠ å…¥å¤±æ•—ï¼š" + (j.error||res.status)); return; }
          closeModal(); location.reload();
        });
        tr.addEventListener("dblclick", ()=>tr.querySelector("button").click());
        tb.appendChild(tr);
      });
    }
    async function api_search(q="",limit=500){
      const r = await fetch(`/approvals/api/approvers/search?limit=${limit}&q=${encodeURIComponent(q)}`);
      return r.json();
    }
    function openModal(loadRecent=true){
      $$("#searchModal").style.display="flex"; document.body.style.overflow="hidden";
      if(loadRecent){ api_search("").then(renderList); }
      $$("#q").focus();
    }
    function closeModal(){
      $$("#searchModal").style.display="none"; document.body.style.overflow="";
    }
    document.getElementById("openSearchBtn")?.addEventListener("click", ()=>{ renderHeader(); openModal(true); });
    document.addEventListener("click",(e)=>{ if(e.target?.id==="closeModal"||e.target?.id==="closeModal2") closeModal(); });
    document.body.addEventListener("click",(e)=>{ if(e.target?.id==="searchModal") closeModal(); });
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });
    let t=null;
    document.body.addEventListener("input", (e)=>{
      if(e.target?.id!=="q") return;
      clearTimeout(t);
      t=setTimeout(async ()=>{
        const q=e.target.value.trim();
        renderList(await api_search(q||"", 500));
      }, 300);
    });
  }

  // === D) æ‹–æ›³é‡æ’ï¼ˆåƒ…ã€Œæœªç°½ã€ä¸”åºè™Ÿ > current_step çš„åˆ—ï¼‰ ===
  const tbody = document.getElementById('stepsTbody');
  let dragEl=null;
  tbody?.addEventListener('dragstart', (e)=>{
    const tr=e.target.closest('tr.draggable'); if(!tr) return;
    dragEl=tr; e.dataTransfer.effectAllowed='move';
  });
  tbody?.addEventListener('dragover', (e)=>{
    if(!dragEl) return;
    const over=e.target.closest('tr'); if(!over) return;
    const canDrop = (over.dataset.pending==='1' && Number(over.dataset.stepOrder)>curStep);
    if(!canDrop) return;
    e.preventDefault();
    const rect=over.getBoundingClientRect();
    const after=(e.clientY-rect.top)>(rect.height/2);
    if(after) over.after(dragEl); else over.before(dragEl);
  });
  document.addEventListener('dragend', async ()=>{
    if(!dragEl) return;
    const rows=[...tbody.querySelectorAll('tr')].filter(tr=>tr.dataset.pending==='1' && Number(tr.dataset.stepOrder)>curStep);
    const order=rows.map(tr=>Number(tr.dataset.stepId));
    dragEl=null;
    try{
      const res=await fetch(`/approvals/${approvalId}/steps/reorder`,{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({order})
      });
      const j=await res.json(); if(!j.ok){ alert('é‡æ’å¤±æ•—ï¼š'+(j.error||res.status)); } else { location.reload(); }
    }catch(e){ alert('é‡æ’å¤±æ•—'); }
  });

  // å¿«æ·éµï¼šA åŒæ„ã€R é€€å›ï¼ˆåªæœ‰å¯ç°½æ ¸è€…æ‰æœƒæœ‰æ•ˆï¼‰
  document.addEventListener('keydown', function(e){
    const actField = document.getElementById('actField');
    if(!actField) return;
    if(e.key.toLowerCase()==='a'){ actField.value='approve'; document.querySelector('button.btn.primary')?.click(); }
    if(e.key.toLowerCase()==='r'){ actField.value='reject';  document.querySelectorAll('button.btn')[1]?.click(); }
  });
})();
</script>
<script>
(function(){
  const btn1 = document.getElementById('btnBuildIdx');
  const btn2 = document.getElementById('btnBuildEmpIdx');

  async function call(url, btn){
    if(!btn) return;
    try{
      btn.disabled = true;
      const res = await fetch(url, {method: 'POST'});
      const j = await res.json();
      alert(j.ok ? (j.msg || 'å®Œæˆ') : ('å¤±æ•—ï¼š' + (j.error || res.status)));
      if(j.ok) location.reload();
    }catch(e){
      alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + (e?.message || e));
    }finally{
      btn.disabled = false;
    }
  }

  btn1?.addEventListener('click', ()=> call('/approvals/debug/build_step_index', btn1));
  btn2?.addEventListener('click', ()=> call('/approvals/debug/build_employee_indexes', btn2));
})();
</script>

{% endblock %}
