{% extends "base.html" %}
{% block title %}ç°½æ ¸è©³æƒ… - {{ approval.subject }} Â· {{ super() if super else 'OneTouch' }}{% endblock %}
{% block content %}
<style>
  .wrap{max-width:1100px;margin:auto;padding:12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin-bottom:12px}
  .muted{color:#6b7280}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 260px}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid #ddd;font-size:12px}
  .ok{background:#ecfdf5}
  .warn{background:#fffbeb}
  .danger{background:#fee2e2}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
  .btn{border:1px solid #2563eb;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff}
  textarea,input[type="text"],select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
</style>
{% if can_act %}
  <div class="card" style="border-color:#86efac;background:#f0fdf4">
    âœ… ä½ æ˜¯ <strong>#{{ approval.current_step + 1 }}</strong> é—œçš„ç°½æ ¸äººï¼Œè«‹å®Œæˆç°½æ ¸ã€‚
  </div>
{% else %}
  {% if approval.status == 'pending' and approval.current_step >= 0 and current_step_obj %}
  <div class="card" style="border-color:#fde68a;background:#fffbeb">
    â³ ç›®å‰ç°½æ ¸äººï¼š<strong>{{ current_step_obj.approver_name }}</strong>ï¼ˆç¬¬ #{{ approval.current_step + 1 }} é—œï¼‰
  </div>
  {% endif %}
{% endif %}

<div class="wrap">
  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2>ğŸ“„ {{ approval.subject }}</h2>
      <div>
        {% if approval.status == 'approved' %}
          <span class="badge ok">å®Œæˆ</span>
        {% elif approval.status == 'rejected' %}
          <span class="badge warn">é€€å›</span>
        {% else %}
          <span class="badge">é€²è¡Œä¸­</span>
        {% endif %}
      </div>
    </div>
    <div class="row">
      <div class="col"><strong>é€ç°½äººï¼š</strong>{{ approval.requester }}</div>
      <div class="col"><strong>é€ç°½éƒ¨é–€ï¼š</strong>{{ approval.requester_dept or '-' }}</div>
      <div class="col"><strong>é€ç°½æ™‚é–“ï¼š</strong><span class="muted">{{ approval.submitted_at }}</span></div>
      <div class="col"><strong>ç›®å‰é—œå¡ï¼š</strong>
        {% if approval.current_step>=0 %}#{{ approval.current_step + 1 }}{% else %}-{% endif %}
      </div>
    </div>
    <div style="margin-top:10px">
      <strong>èªªæ˜ï¼š</strong>
      <div class="muted" style="white-space:pre-wrap">{{ approval.description or 'ï¼ˆç„¡ï¼‰' }}</div>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ§­ ä¸²ç°½æµç¨‹</h3>
    <table>
      <thead>
        <tr><th style="width:70px">é—œå¡</th><th>ç°½æ ¸äºº</th><th style="width:130px">ç‹€æ…‹</th><th style="width:170px">è™•ç†æ™‚é–“</th><th>æ„è¦‹</th></tr>
      </thead>
      <tbody>
        {% for s in steps %}
        <tr {% if approval.current_step == s.step_order and s.status=='pending' %}style="background:#f9fafb"{% endif %}>
          <td>#{{ s.step_order + 1 }}</td>
          <td>{{ s.approver_name }} <div class="muted">{{ s.approver_email or '' }}</div></td>
          <td>
            {% if s.status == 'approved' %}<span class="badge ok">åŒæ„</span>
            {% elif s.status == 'rejected' %}<span class="badge danger">é€€å›</span>
            {% else %}<span class="badge">å¾…ç°½</span>{% endif %}
          </td>
          <td class="muted">{{ s.decided_at or '' }}</td>
          <td style="white-space:pre-wrap">{{ s.comment or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if can_act %}
    <form method="post" action="/approvals/{{ approval.id }}/action" style="margin-top:16px">
      <label>ç°½æ ¸æ„è¦‹ï¼ˆå¯ç•™ç©ºï¼‰</label>
      <textarea name="comment" rows="4" placeholder="è¼¸å…¥çµ¦ç”³è«‹äººæˆ–ä¸‹ä¸€é—œçš„è¨Šæ¯â€¦"></textarea>
      <input type="hidden" name="action" id="actField" value="approve">
      <div style="margin-top:10px;display:flex;gap:10px">
        <button class="btn primary" onclick="document.getElementById('actField').value='approve'">âœ… åŒæ„</button>
        <button class="btn" onclick="document.getElementById('actField').value='reject'">â†©ï¸ é€€å›</button>
        <a href="/approvals" class="btn">è¿”å›æ¸…å–®</a>
      </div>
      <p class="muted" style="margin-top:6px">ä½ æ˜¯æ­¤å–®ç›®å‰é—œå¡çš„ç°½æ ¸äººï¼Œè™•ç†å¾Œç³»çµ±æœƒè‡ªå‹•é€šçŸ¥ä¸‹ä¸€é—œæˆ–ç”³è«‹äººã€‚</p>
    </form>
    {% else %}
      <div style="margin-top:10px">
        <a href="/approvals" class="btn">è¿”å›æ¸…å–®</a>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <h3>ğŸ—‚ï¸ æ­·ç¨‹</h3>
    {% if actions and actions|length>0 %}
    <table>
      <thead><tr><th style="width:160px">æ™‚é–“</th><th style="width:140px">å‹•ä½œè€…</th><th style="width:100px">å‹•ä½œ</th><th>å…§å®¹</th></tr></thead>
      <tbody>
        {% for a in actions %}
        <tr>
          <td class="muted">{{ a.created_at }}</td>
          <td>{{ a.actor }}</td>
          <td>{{ 'é€å‡º' if a.action=='submit' else ('åŒæ„' if a.action=='approve' else ('é€€å›' if a.action=='reject' else a.action)) }}</td>
          <td style="white-space:pre-wrap">{{ a.note or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p class="muted">å°šç„¡æ­·ç¨‹ã€‚</p>
    {% endif %}
  </div>
</div>
<script>
document.addEventListener('keydown', function(e){
  const actField = document.getElementById('actField');
  if(!actField) return; // ä¸æ˜¯ç°½æ ¸è€…å°±æ²’æœ‰æŒ‰éˆ•
  if(e.key.toLowerCase()==='a'){ actField.value='approve'; document.querySelector('button.btn.primary')?.click(); }
  if(e.key.toLowerCase()==='r'){ actField.value='reject';  document.querySelectorAll('button.btn')[1]?.click(); }
});
</script>

{% endblock %}
