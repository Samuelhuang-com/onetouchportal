{% extends "base.html" %} {% block title %}簽核清單 - {{ super() if super else
'OneTouch' }}{% endblock %} {% block content %}
<style>
  .wrap {
    max-width: 1100px;
    margin: auto;
    padding: 8px;
  }
  .card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    padding: 14px;
    margin-bottom: 12px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th,
  td {
    border-bottom: 1px solid #eee;
    padding: 8px;
    text-align: left;
    vertical-align: top;
  }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid #ddd;
    font-size: 12px;
  }
  .ok {
    background: #ecfdf5;
  }
  .warn {
    background: #fffbeb;
  }
  .muted {
    color: #6b7280;
  }
  .btn {
    border: 1px solid #2563eb;
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
    background: #fff;
  }
  .btn.primary {
    background: #2563eb;
    color: #fff;
  }
  .btn.ghost {
    background: #fff;
  }

  /* ===== Modal 搜尋 ===== */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 60;
  }
  .modal {
    width: min(1100px, 92vw);
    max-height: 86vh;
    overflow: hidden;
    background: #fff;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.18);
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    padding: 12px 14px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: space-between;
  }
  .modal-title {
    font-weight: 700;
  }
  .modal-body {
    padding: 12px 14px;
    overflow: auto;
  }
  .modal-footer {
    border-top: 1px solid #e5e7eb;
    padding: 10px 14px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
  .searchbar {
    display: flex;
    gap: 8px;
    align-items: center;
    width: 100%;
  }
  .searchbar input[type="search"] {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    font-size: 14px;
  }
  .tableR {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 6px;
  }
  .rowr {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    cursor: pointer;
  }
  .rowr:hover {
    background: #f9fafb;
  }
  .rowr td {
    padding: 8px;
  }
  .subline {
    font-size: 12px;
    color: #6b7280;
  }
  .controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }
  .controls select,
  .controls input[type="date"] {
    padding: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }
</style>

<div class="wrap">
  <div class="card">
    <div
      style="display: flex; justify-content: space-between; align-items: center"
    >
      <div style="display: flex; align-items: center; gap: 8px">
        <div id="lottie-attention" style="width: 50px; height: 50px"></div>
        <h2>🖊️ 我需要簽</h2>
      </div>
      <div style="display: flex; gap: 8px">
        <button type="button" class="btn primary" id="openSearch">
          🔎 搜尋
        </button>
        <a class="btn primary" href="/approvals/new">➕ 建立簽核單</a>
      </div>
    </div>
    {% if my_todo and my_todo|length>0 %}
    <table>
      <thead>
        <tr>
          <th>主旨</th>
          <th>送簽人</th>
          <th>目前關卡</th>
          <th>送簽時間</th>
        </tr>
      </thead>
      <tbody>
        {% for r in my_todo %}
        <tr
          onclick="location.href='/approvals/{{ r.id }}'"
          style="cursor: pointer"
        >
          <td>{{ r.subject }}</td>
          <td>{{ r.requester }}</td>
          <td>#{{ r.step + 1 }}</td>
          <td class="muted">{{ r.submitted_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="muted">目前沒有待簽事項。</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>📤 我送簽</h2>
    {% if my_sent and my_sent|length>0 %}
    <table>
      <thead>
        <tr>
          <th>主旨</th>
          <th>狀態</th>
          <th>目前關卡</th>
          <th>送簽時間</th>
        </tr>
      </thead>
      <tbody>
        {% for r in my_sent %}
        <tr
          onclick="location.href='/approvals/{{ r.id }}'"
          style="cursor: pointer"
        >
          <td>{{ r.subject }}</td>
          <td>
            {% if r.status=='approved' %}<span class="badge ok">完成</span> {%
            elif r.status=='rejected' %}<span class="badge warn">退回</span> {%
            else %}<span class="badge">進行中</span>{% endif %}
          </td>
          <td>
            {% if r.current_step>=0 %}#{{ r.current_step + 1 }}{% else %}-{%
            endif %}
          </td>
          <td class="muted">{{ r.submitted_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="muted">尚未送出簽核。</p>
    {% endif %}
  </div>
</div>

<div class="modal-backdrop" id="searchModal">
  <div
    class="modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="modalTitle"
  >
    <div class="modal-header">
      <div class="searchbar">
        <strong class="modal-title" id="modalTitle">🔎 簽核內容搜尋</strong>
        <input
          id="q"
          type="search"
          placeholder="輸入關鍵字（主旨、內容、送簽人、簽核人…）"
        />
        <div class="controls">
          <select id="scope">
            <option value="all">全部</option>
            <option value="todo">我的待簽</option>
            <option value="mine">我送簽</option>
          </select>
          <select id="status">
            <option value="all">全部狀態</option>
            <option value="pending">進行中</option>
            <option value="approved">完成</option>
            <option value="rejected">退回</option>
          </select>
          <input id="from" type="date" />
          <input id="to" type="date" />
          <button class="btn primary" id="btnRecent" type="button">
            最近50筆
          </button>
        </div>
      </div>
      <button
        class="btn primary"
        id="closeModal"
        aria-label="Close"
        type="button"
      >
        ✖
      </button>
    </div>
    <div class="modal-body">
      <div class="muted" style="margin-bottom: 6px">點擊任一列以開啟簽核單</div>
      <div style="overflow: auto">
        <table class="tableR">
          <tbody id="list"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn primary" id="closeModal2" type="button">關閉</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<script>
  // 2. 將你的 JSON 內容儲存到一個變數中
  const animationData = {
    v: "5.3.4",
    fr: 48,
    ip: 0,
    op: 146,
    w: 950,
    h: 900,
    nm: "att",
    ddd: 0,
    assets: [],
    layers: [
      {
        ddd: 0,
        ind: 1,
        ty: 4,
        nm: "arr",
        sr: 1,
        ks: {
          o: { a: 0, k: 100, ix: 11 },
          r: { a: 0, k: -5, ix: 10 },
          p: { a: 0, k: [483, 386, 0], ix: 2 },
          a: { a: 0, k: [0, 0, 0], ix: 1 },
          s: { a: 0, k: [100, 100, 100], ix: 6 },
        },
        ao: 0,
        shapes: [
          {
            ty: "gr",
            it: [
              {
                ind: 0,
                ty: "sh",
                ix: 1,
                ks: {
                  a: 1,
                  k: [
                    {
                      i: { x: 0, y: 1 },
                      o: { x: 0.167, y: 0.167 },
                      n: "0_1_0p167_0p167",
                      t: 57,
                      s: [
                        {
                          i: [
                            [0.01, 0.007],
                            [0, 0],
                            [0.001, -0.013],
                            [0.062, -0.737],
                            [0.069, -0.82],
                            [-0.005, -0.003],
                            [-0.006, 0.003],
                            [0, 0],
                          ],
                          o: [
                            [0, 0],
                            [-0.01, -0.008],
                            [-0.062, 0.737],
                            [-0.069, 0.82],
                            [0, 0.006],
                            [0.005, 0.003],
                            [0, 0],
                            [0.011, -0.005],
                          ],
                          v: [
                            [181.99, -185.95],
                            [178.402, -188.603],
                            [178.376, -188.591],
                            [178.19, -186.379],
                            [177.984, -183.921],
                            [177.991, -183.906],
                            [178.007, -183.905],
                            [181.988, -185.922],
                          ],
                          c: true,
                        },
                      ],
                      e: [
                        {
                          i: [
                            [0.6, 0.444],
                            [0, 0],
                            [0.066, -0.783],
                            [3.845, -45.776],
                            [4.274, -50.878],
                            [-0.301, -0.203],
                            [-0.35, 0.178],
                            [0, 0],
                          ],
                          o: [
                            [0, 0],
                            [-0.632, -0.467],
                            [-3.845, 45.776],
                            [-4.274, 50.878],
                            [-0.03, 0.362],
                            [0.284, 0.191],
                            [0, 0],
                            [0.666, -0.337],
                          ],
                          v: [
                            [448.076, -166.764],
                            [225.292, -331.483],
                            [223.696, -330.76],
                            [212.16, -193.433],
                            [199.338, -40.798],
                            [199.777, -39.882],
                            [200.791, -39.819],
                            [447.933, -165.062],
                          ],
                          c: true,
                        },
                      ],
                    },
                    {
                      i: { x: 0, y: 1 },
                      o: { x: 0.333, y: 0 },
                      n: "0_1_0p333_0",
                      t: 77,
                      s: [
                        {
                          i: [
                            [0.6, 0.444],
                            [0, 0],
                            [0.066, -0.783],
                            [3.845, -45.776],
                            [4.274, -50.878],
                            [-0.301, -0.203],
                            [-0.35, 0.178],
                            [0, 0],
                          ],
                          o: [
                            [0, 0],
                            [-0.632, -0.467],
                            [-3.845, 45.776],
                            [-4.274, 50.878],
                            [-0.03, 0.362],
                            [0.284, 0.191],
                            [0, 0],
                            [0.666, -0.337],
                          ],
                          v: [
                            [448.076, -166.764],
                            [225.292, -331.483],
                            [223.696, -330.76],
                            [212.16, -193.433],
                            [199.338, -40.798],
                            [199.777, -39.882],
                            [200.791, -39.819],
                            [447.933, -165.062],
                          ],
                          c: true,
                        },
                      ],
                      e: [
                        {
                          i: [
                            [0.6, 0.444],
                            [0, 0],
                            [0.066, -0.783],
                            [3.845, -45.776],
                            [4.274, -50.878],
                            [-0.301, -0.203],
                            [-0.35, 0.178],
                            [0, 0],
                          ],
                          o: [
                            [0, 0],
                            [-0.632, -0.467],
                            [-3.845, 45.776],
                            [-4.274, 50.878],
                            [-0.03, 0.362],
                            [0.284, 0.191],
                            [0, 0],
                            [0.666, -0.337],
                          ],
                          v: [
                            [448.076, -166.764],
                            [225.292, -331.483],
                            [223.696, -330.76],
                            [212.16, -193.433],
                            [199.338, -40.798],
                            [199.777, -39.882],
                            [200.791, -39.819],
                            [447.933, -165.062],
                          ],
                          c: true,
                        },
                      ],
                    },
                    {
                      i: { x: 0.253, y: 1 },
                      o: { x: 0.333, y: 0 },
                      n: "0p253_1_0p333_0",
                      t: 112,
                      s: [
                        {
                          i: [
                            [0.6, 0.444],
                            [0, 0],
                            [0.066, -0.783],
                            [3.845, -45.776],
                            [4.274, -50.878],
                            [-0.301, -0.203],
                            [-0.35, 0.178],
                            [0, 0],
                          ],
                          o: [
                            [0, 0],
                            [-0.632, -0.467],
                            [-3.845, 45.776],
                            [-4.274, 50.878],
                            [-0.03, 0.362],
                            [0.284, 0.191],
                            [0, 0],
                            [0.666, -0.337],
                          ],
                          v: [
                            [448.076, -166.764],
                            [225.292, -331.483],
                            [223.696, -330.76],
                            [212.16, -193.433],
                            [199.338, -40.798],
                            [199.777, -39.882],
                            [200.791, -39.819],
                            [447.933, -165.062],
                          ],
                          c: true,
                        },
                      ],
                      e: [
                        {
                          i: [
                            [0.005, 0.003],
                            [0, 0],
                            [0.001, -0.006],
                            [0.029, -0.348],
                            [0.032, -0.387],
                            [-0.002, -0.002],
                            [-0.003, 0.001],
                            [0, 0],
                          ],
                          o: [
                            [0, 0],
                            [-0.005, -0.004],
                            [-0.029, 0.348],
                            [-0.033, 0.387],
                            [0, 0.003],
                            [0.002, 0.001],
                            [0, 0],
                            [0.005, -0.003],
                          ],
                          v: [
                            [-321.158, -216.214],
                            [-322.852, -217.466],
                            [-322.864, -217.461],
                            [-322.952, -216.416],
                            [-323.049, -215.256],
                            [-323.046, -215.249],
                            [-323.038, -215.248],
                            [-321.159, -216.201],
                          ],
                          c: true,
                        },
                      ],
                    },
                    { t: 137 },
                  ],
                  ix: 2,
                },
                nm: "Path 1",
                mn: "ADBE Vector Shape - Group",
                hd: false,
              },
              {
                ty: "st",
                c: { a: 0, k: [0, 0, 0, 1], ix: 3 },
                o: { a: 0, k: 100, ix: 4 },
                w: { a: 0, k: 60, ix: 5 },
                lc: 1,
                lj: 1,
                ml: 10,
                ml2: { a: 0, k: 10, ix: 8 },
                nm: "Stroke 1",
                mn: "ADBE Vector Graphic - Stroke",
                hd: false,
              },
              {
                ty: "tr",
                p: { a: 0, k: [0, 0], ix: 2 },
                a: { a: 0, k: [0, 0], ix: 1 },
                s: { a: 0, k: [100, 100], ix: 3 },
                r: { a: 0, k: 0, ix: 6 },
                o: { a: 0, k: 100, ix: 7 },
                sk: { a: 0, k: 0, ix: 4 },
                sa: { a: 0, k: 0, ix: 5 },
                nm: "Transform",
              },
            ],
            nm: "Group 1",
            np: 2,
            cix: 2,
            ix: 1,
            mn: "ADBE Vector Group",
            hd: false,
          },
        ],
        ip: 58,
        op: 131,
        st: 0,
        bm: 0,
      },
      {
        ddd: 0,
        ind: 2,
        ty: 4,
        nm: "line 2",
        sr: 1,
        ks: {
          o: { a: 0, k: 100, ix: 11 },
          r: { a: 0, k: -5, ix: 10 },
          p: { a: 0, k: [482.826, 384.008, 0], ix: 2 },
          a: { a: 0, k: [0, 0, 0], ix: 1 },
          s: { a: 0, k: [100, 100, 100], ix: 6 },
        },
        ao: 0,
        shapes: [
          {
            ty: "gr",
            it: [
              {
                ind: 0,
                ty: "sh",
                ix: 1,
                ks: {
                  a: 0,
                  k: {
                    i: [
                      [0, 0],
                      [-9.247, 84.584],
                      [26.832, 13.316],
                      [-39.475, 155.781],
                      [107.602, 84.195],
                      [-95.777, 7.693],
                    ],
                    o: [
                      [98.494, -5.829],
                      [8.396, -76.811],
                      [82.332, -12.434],
                      [39.464, -155.74],
                      [143.102, -10.805],
                      [95.777, -7.693],
                    ],
                    v: [
                      [-397.474, 478.566],
                      [-127.753, 328.416],
                      [-320.332, 180.434],
                      [150.475, 119.219],
                      [-377.102, -161.695],
                      [172.277, -138.193],
                    ],
                    c: false,
                  },
                  ix: 2,
                },
                nm: "Path 1",
                mn: "ADBE Vector Shape - Group",
                hd: false,
              },
              {
                ty: "st",
                c: { a: 0, k: [0, 0, 0, 1], ix: 3 },
                o: { a: 0, k: 100, ix: 4 },
                w: { a: 0, k: 9, ix: 5 },
                lc: 2,
                lj: 1,
                ml: 10,
                ml2: { a: 0, k: 10, ix: 8 },
                nm: "Stroke 1",
                mn: "ADBE Vector Graphic - Stroke",
                hd: false,
              },
              {
                ty: "tr",
                p: { a: 0, k: [0, 0], ix: 2 },
                a: { a: 0, k: [0, 0], ix: 1 },
                s: { a: 0, k: [100, 100], ix: 3 },
                r: { a: 0, k: 0, ix: 6 },
                o: { a: 0, k: 100, ix: 7 },
                sk: { a: 0, k: 0, ix: 4 },
                sa: { a: 0, k: 0, ix: 5 },
                nm: "Transform",
              },
            ],
            nm: "Group 1",
            np: 2,
            cix: 2,
            ix: 1,
            mn: "ADBE Vector Group",
            hd: false,
          },
          {
            ty: "tm",
            s: {
              a: 1,
              k: [
                {
                  i: { x: [0.833], y: [0.83] },
                  o: { x: [0.884], y: [0] },
                  n: ["0p833_0p83_0p884_0"],
                  t: 5,
                  s: [0],
                  e: [100],
                },
                { t: 59 },
              ],
              ix: 1,
            },
            e: {
              a: 1,
              k: [
                {
                  i: { x: [0.833], y: [0.833] },
                  o: { x: [0.846], y: [0] },
                  n: ["0p833_0p833_0p846_0"],
                  t: 0,
                  s: [0],
                  e: [100],
                },
                { t: 57 },
              ],
              ix: 2,
            },
            o: { a: 0, k: 0, ix: 3 },
            m: 1,
            ix: 2,
            nm: "Trim Paths 1",
            mn: "ADBE Vector Filter - Trim",
            hd: false,
          },
        ],
        ip: 0,
        op: 60,
        st: 0,
        bm: 0,
      },
      {
        ddd: 0,
        ind: 3,
        ty: 4,
        nm: "line 3",
        sr: 1,
        ks: {
          o: { a: 0, k: 100, ix: 11 },
          r: { a: 0, k: -5, ix: 10 },
          p: { a: 0, k: [483, 386, 0], ix: 2 },
          a: { a: 0, k: [0, 0, 0], ix: 1 },
          s: { a: 0, k: [100, 100, 100], ix: 6 },
        },
        ao: 0,
        shapes: [
          {
            ty: "gr",
            it: [
              {
                ind: 0,
                ty: "sh",
                ix: 1,
                ks: {
                  a: 0,
                  k: {
                    i: [
                      [0, 0],
                      [-9.277, 42.089],
                      [-6.888, 83.46],
                      [-36.491, 99.296],
                      [-73.222, 126.322],
                      [-280.817, -6.736],
                    ],
                    o: [
                      [98.494, -5.829],
                      [16.633, -75.457],
                      [5.564, -67.424],
                      [43.434, -118.189],
                      [38.152, -65.82],
                      [0, 0],
                    ],
                    v: [
                      [-426.777, 433.102],
                      [-177.239, 331.012],
                      [-416.676, 151.263],
                      [101.01, 115.158],
                      [-433.102, -185.695],
                      [176.777, -186.193],
                    ],
                    c: false,
                  },
                  ix: 2,
                },
                nm: "Path 1",
                mn: "ADBE Vector Shape - Group",
                hd: false,
              },
              {
                ty: "st",
                c: { a: 0, k: [0, 0, 0, 1], ix: 3 },
                o: { a: 0, k: 100, ix: 4 },
                w: { a: 0, k: 60, ix: 5 },
                lc: 2,
                lj: 1,
                ml: 10,
                ml2: { a: 0, k: 10, ix: 8 },
                nm: "Stroke 1",
                mn: "ADBE Vector Graphic - Stroke",
                hd: false,
              },
              {
                ty: "tr",
                p: { a: 0, k: [0, 0], ix: 2 },
                a: { a: 0, k: [0, 0], ix: 1 },
                s: { a: 0, k: [100, 100], ix: 3 },
                r: { a: 0, k: 0, ix: 6 },
                o: { a: 0, k: 100, ix: 7 },
                sk: { a: 0, k: 0, ix: 4 },
                sa: { a: 0, k: 0, ix: 5 },
                nm: "Transform",
              },
            ],
            nm: "Group 1",
            np: 2,
            cix: 2,
            ix: 1,
            mn: "ADBE Vector Group",
            hd: false,
          },
          {
            ty: "tm",
            s: { a: 0, k: 79, ix: 1 },
            e: {
              a: 1,
              k: [
                {
                  i: { x: [0.774], y: [0.533] },
                  o: { x: [0.478], y: [0] },
                  n: ["0p774_0p533_0p478_0"],
                  t: 113,
                  s: [100],
                  e: [97],
                },
                {
                  i: { x: [0.116], y: [1] },
                  o: { x: [0.146], y: [0.302] },
                  n: ["0p116_1_0p146_0p302"],
                  t: 117,
                  s: [97],
                  e: [79],
                },
                { t: 141 },
              ],
              ix: 2,
            },
            o: { a: 0, k: 0, ix: 3 },
            m: 1,
            ix: 2,
            nm: "Trim Paths 1",
            mn: "ADBE Vector Filter - Trim",
            hd: false,
          },
        ],
        ip: 92,
        op: 137,
        st: 92,
        bm: 0,
      },
      {
        ddd: 0,
        ind: 4,
        ty: 4,
        nm: "line",
        sr: 1,
        ks: {
          o: { a: 0, k: 100, ix: 11 },
          r: { a: 0, k: -5, ix: 10 },
          p: { a: 0, k: [483, 386, 0], ix: 2 },
          a: { a: 0, k: [0, 0, 0], ix: 1 },
          s: { a: 0, k: [100, 100, 100], ix: 6 },
        },
        ao: 0,
        shapes: [
          {
            ty: "gr",
            it: [
              {
                ind: 0,
                ty: "sh",
                ix: 1,
                ks: {
                  a: 0,
                  k: {
                    i: [
                      [0, 0],
                      [-9.277, 42.089],
                      [-6.888, 83.46],
                      [-36.491, 99.296],
                      [-73.222, 126.322],
                      [-280.817, -6.736],
                    ],
                    o: [
                      [98.494, -5.829],
                      [16.633, -75.457],
                      [5.564, -67.424],
                      [43.434, -118.189],
                      [38.152, -65.82],
                      [0, 0],
                    ],
                    v: [
                      [-426.777, 433.102],
                      [-177.239, 331.012],
                      [-416.676, 151.263],
                      [101.01, 115.158],
                      [-433.102, -185.695],
                      [176.777, -186.193],
                    ],
                    c: false,
                  },
                  ix: 2,
                },
                nm: "Path 1",
                mn: "ADBE Vector Shape - Group",
                hd: false,
              },
              {
                ty: "st",
                c: { a: 0, k: [0, 0, 0, 1], ix: 3 },
                o: { a: 0, k: 100, ix: 4 },
                w: { a: 0, k: 60, ix: 5 },
                lc: 2,
                lj: 1,
                ml: 10,
                ml2: { a: 0, k: 10, ix: 8 },
                nm: "Stroke 1",
                mn: "ADBE Vector Graphic - Stroke",
                hd: false,
              },
              {
                ty: "tr",
                p: { a: 0, k: [0, 0], ix: 2 },
                a: { a: 0, k: [0, 0], ix: 1 },
                s: { a: 0, k: [100, 100], ix: 3 },
                r: { a: 0, k: 0, ix: 6 },
                o: { a: 0, k: 100, ix: 7 },
                sk: { a: 0, k: 0, ix: 4 },
                sa: { a: 0, k: 0, ix: 5 },
                nm: "Transform",
              },
            ],
            nm: "Group 1",
            np: 2,
            cix: 2,
            ix: 1,
            mn: "ADBE Vector Group",
            hd: false,
          },
          {
            ty: "tm",
            s: {
              a: 1,
              k: [
                {
                  i: { x: [0], y: [1] },
                  o: { x: [0.167], y: [0.187] },
                  n: ["0_1_0p167_0p187"],
                  t: 37,
                  s: [0],
                  e: [79],
                },
                { t: 92 },
              ],
              ix: 1,
            },
            e: {
              a: 1,
              k: [
                {
                  i: { x: [0.833], y: [0.833] },
                  o: { x: [0.758], y: [0] },
                  n: ["0p833_0p833_0p758_0"],
                  t: 0,
                  s: [0],
                  e: [100],
                },
                { t: 57 },
              ],
              ix: 2,
            },
            o: { a: 0, k: 0, ix: 3 },
            m: 1,
            ix: 2,
            nm: "Trim Paths 1",
            mn: "ADBE Vector Filter - Trim",
            hd: false,
          },
        ],
        ip: 0,
        op: 92,
        st: 0,
        bm: 0,
      },
    ],
    markers: [],
  };

  // 3. 在頁面載入後，執行 Lottie 的初始化
  window.addEventListener("load", () => {
    lottie.loadAnimation({
      container: document.getElementById("lottie-attention"), // 動畫容器
      renderer: "svg",
      loop: true,
      autoplay: true,
      animationData: animationData, // 動畫資料
    });
  });
</script>
<script type="module" src="{{ url_for('static', path='main.js') }}"></script>
<script>
  const $ = (id) => document.getElementById(id);
  function openModal() {
    $("searchModal").style.display = "flex";
    document.body.style.overflow = "hidden";
    $("q").focus();
  }
  function closeModal() {
    $("searchModal").style.display = "none";
    document.body.style.overflow = "";
  }

  function esc(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
  function badge(status) {
    if (status === "approved") return '<span class="badge ok">完成</span>';
    if (status === "rejected") return '<span class="badge warn">退回</span>';
    return '<span class="badge">進行中</span>';
  }
  function renderRows(rows) {
    const tb = $("list");
    tb.innerHTML = "";
    rows.forEach((r) => {
      const tr = document.createElement("tr");
      tr.className = "rowr";
      tr.innerHTML = `
        <td>
          <div><strong>${esc(r.subject)}</strong></div>
          <div class="subline">
            送簽人：${esc(r.requester)}　狀態：${badge(r.status)}　關卡：${
        r.current_step ? "#" + r.current_step : "-"
      }　時間：${esc(r.submitted_at)}
          </div>
          ${
            r.preview
              ? `<div class="subline">內容摘錄：${esc(r.preview)}</div>`
              : ""
          }
        </td>
      `;
      tr.addEventListener(
        "click",
        () => (location.href = "/approvals/" + r.id)
      );
      tb.appendChild(tr);
    });
  }

  async function search() {
    const params = new URLSearchParams();
    const q = $("q").value.trim();
    if (q) params.set("q", q);
    params.set("scope", $("scope").value);
    params.set("status", $("status").value);
    const f = $("from").value,
      t = $("to").value;
    if (f) params.set("date_from", f);
    if (t) params.set("date_to", t);
    params.set("limit", "100");
    const res = await fetch(`/approvals/api/search?${params.toString()}`);
    const data = await res.json();
    renderRows(Array.isArray(data) ? data : []);
  }

  // debounce
  function debounce(fn, ms = 300) {
    let t;
    return (...a) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...a), ms);
    };
  }

  window.addEventListener("load", () => {
    $("openSearch").addEventListener("click", () => {
      openModal();
      recent();
    });
    $("closeModal").addEventListener("click", closeModal);
    $("closeModal2").addEventListener("click", closeModal);
    $("searchModal").addEventListener("click", (e) => {
      if (e.target === $("searchModal")) closeModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    $("q").addEventListener("input", debounce(search, 300));
    $("scope").addEventListener("change", search);
    $("status").addEventListener("change", search);
    $("from").addEventListener("change", search);
    $("to").addEventListener("change", search);

    $("btnRecent").addEventListener("click", recent);
  });

  async function recent() {
    $("q").value = "";
    $("from").value = "";
    $("to").value = "";
    $("scope").value = "all";
    $("status").value = "all";
    const res = await fetch(`/approvals/api/search?limit=50`);
    const data = await res.json();
    renderRows(Array.isArray(data) ? data : []);
  }
</script>

{% endblock %}
