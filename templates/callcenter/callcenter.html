{% extends "base.html" %} {% block title %}ç¸½æ©Ÿå®¢æœç™»è¨˜ - {{ super() if super
else 'OneTouch' }}{% endblock %} {% block content %}
<style>
  :root {
    --bg: #f3f4f6;
    --card: #fff;
    --text: #111827;
    --muted: #6b7280;
    --primary: #2563eb;
    --bd: #e5e7eb;
    --ok: #16a34a;
    --warn: #f59e0b;
    --danger: #dc2626;
  }
  .wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: 16px;
  }
  .card {
    background: var(--card);
    border: 1px solid var(--bd);
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    padding: 14px;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  h1 {
    font-size: 20px;
    margin: 0;
  }
  .badge {
    display: inline-block;
    border: 1px solid var(--bd);
    color: var(--muted);
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 12px;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 12px;
  }
  .field {
    background: #fff;
    border: 1px solid var(--bd);
    border-radius: 10px;
    padding: 10px 12px;
  }

  /* é è¨­ span-4ï¼Œæ–¹ä¾¿å¤§å¤šæ•¸æ¬„ä½ */
  .field:not([class*="span-"]) {
    grid-column: span 4;
  }
  .field label {
    font-size: 12px;
    color: var(--muted);
    display: block;
    margin-bottom: 6px;
  }
  .field input,
  .field select,
  .field textarea {
    width: 100%;
    border: 0;
    outline: none;
    font-size: 14px;
    background: transparent;
  }
  .span-6 {
    grid-column: span 6;
  }
  .span-12 {
    grid-column: span 12;
  }
  .actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding-top: 8px;
  }
  .btn {
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid var(--bd);
    background: #fff;
    cursor: pointer;
    font-size: 14px;
  }
  .btn.primary {
    background: var(--primary);
    color: #fff;
    border-color: transparent;
  }
  .btn.ghost {
    background: #fff;
  }
  .hint {
    font-size: 12px;
    color: var(--muted);
  }

  /* æœå°‹å·¥å…·åˆ—ï¼ˆåƒ…ä¸Šæ–¹ä¸€é¡†æŒ‰éˆ•ï¼‰ */
  .toolbar {
    display: flex;
    justify-content: flex-end;
    margin: 16px 0 0;
  }

  /* Modal */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 60;
  }
  .modal {
    width: min(1100px, 92vw);
    max-height: 86vh;
    overflow: hidden;
    background: #fff;
    border-radius: 16px;
    border: 1px solid var(--bd);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.18);
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    padding: 12px 14px;
    border-bottom: 1px solid var(--bd);
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: space-between;
  }
  .modal-title {
    font-weight: 700;
  }
  .modal-body {
    padding: 12px 14px;
    overflow: auto;
  }
  .modal-footer {
    border-top: 1px solid var(--bd);
    padding: 10px 14px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
  .searchbar {
    display: flex;
    gap: 8px;
    align-items: center;
    width: 100%;
  }
  .searchbar input[type="search"] {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid var(--bd);
    font-size: 14px;
  }
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 8px;
    min-width: 1100px;
  }
  .row {
    background: #fff;
    border: 1px solid var(--bd);
    border-radius: 10px;
  }
  .row td {
    padding: 8px;
    border-bottom: 1px dashed #eee;
    font-size: 14px;
  }
  .row td:last-child {
    border-bottom: 0;
  }
  .ok {
    color: var(--ok);
  }
  .warn {
    color: var(--warn);
  }
  .danger {
    color: var(--danger);
  }
  .btn.secondary {
    background: #f3f4f6;
    color: var(--text);
    border: 1px solid var(--bd);
  }
</style>

<div class="wrap">
  <div class="header">
    <h1>â˜ï¸ ç¸½æ©Ÿå®¢æœç™»è¨˜</h1>
    <span class="badge">OneTouch Portal</span>
  </div>

  <!-- è¡¨å–®å¡ç‰‡ï¼ˆä¸ŠåŠéƒ¨ï¼‰ -->
  <form id="ticketForm" class="card" autocomplete="off">
    <div class="grid">
      <div class="field">
        <label>ğŸ“… æ—¥æœŸ</label>
        <input id="date" name="date_" type="date" required />
      </div>
      <div class="field">
        <label>ğŸ•˜ æ¥è½æ™‚é–“</label>
        <input id="answer_time" name="answer_time" type="time" required />
      </div>
      <div class="field">
        <label>ğŸ“Œ ç‹€æ…‹</label>
        <select id="status" name="status"></select>
      </div>
      <div class="field">
        <label>ğŸ“ ä¾†æº</label>
        <select id="channel" name="channel" required></select>
      </div>

      <div class="field">
        <label>ğŸ‘¤ ä¾†é›»å§“å</label>
        <input
          id="caller_name"
          name="caller_name"
          type="text"
          placeholder="ç‹å°æ˜"
        />
      </div>
      <div class="field">
        <label>ğŸ“± é›»è©±</label>
        <input id="phone" name="phone" type="tel" placeholder="0912-345-678" />
      </div>
      <div class="field span-12">
        <label>ğŸ“ è¨´æ±‚</label>
        <textarea
          id="issue"
          name="issue"
          required
          placeholder="è«‹ç°¡è¿°å®¢äººè¨´æ±‚â€¦"
        ></textarea>
      </div>
      <div class="field span-6">
        <label>ğŸ¢ è½‰æ¥éƒ¨é–€</label>
        <select id="dept" name="dept"></select>
      </div>
      <div class="field span-6">
        <label>ğŸ‘¥ è½‰æ¥äººå“¡</label>
        <select id="assignee" name="assignee">
          <option value="">è«‹å…ˆé¸éƒ¨é–€</option>
        </select>
      </div>
      <div class="field span-12">
        <label>ğŸ§¾ å‚™è¨»</label>
        <textarea
          id="note"
          name="note"
          placeholder="è£œå……è³‡è¨Šã€æºé€šé‡é»â€¦"
        ></textarea>
      </div>
    </div>

    <div class="actions">
      <button class="btn secondary" type="button" id="openSearchBtn">
        ğŸ” æœå°‹
      </button>
      <button class="btn primary" type="reset">æ¸…é™¤</button>
      <button class="btn primary" type="submit">é€å‡º</button>
    </div>
  </form>

  <!-- ä¸‹åŠéƒ¨ä¸å†å¸¸é§é¡¯ç¤ºï¼Œæ”¹ç‚ºé»ã€Œæœå°‹ã€å½ˆå‡º Modal -->
</div>

<!-- æœå°‹ Modal -->
<div class="modal-backdrop" id="searchModal">
  <div
    class="modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="modalTitle"
  >
    <div class="modal-header">
      <div class="searchbar">
        <strong class="modal-title" id="modalTitle">ğŸ” å®¢æœç´€éŒ„æœå°‹</strong>
        <input id="q" type="search" placeholder="è¼¸å…¥é—œéµå­—ï¼ˆè·¨æ‰€æœ‰æ¬„ä½ï¼‰" />
        <button class="btn primary" id="btnRecent">æœ€è¿‘50ç­†</button>
      </div>
      <button class="btn primary" id="closeModal" aria-label="Close">âœ–</button>
    </div>
    <div class="modal-body">
      <div
        style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px"
      >
        <span class="badge">ç­†æ•¸ <span id="counter">0</span></span>
      </div>
      <div class="card" style="padding: 0; border: none; box-shadow: none">
        <div class="table-wrap" style="overflow: auto">
          <table class="table">
            <thead id="thead"></thead>
            <tbody id="list"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn primary" id="closeModal2">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  let INIT = {
    depts: [],
    agentsByDept: {},
    channels: [],
    statuses: [],
    headers: [],
  };
  let HEADERS = [];
  let CACHE_RECENT = []; // å¿«å–æœ€è¿‘ 50 ç­†

  /* ------- å…±ç”¨ ------- */
  function fillSelect(sel, items, placeholder) {
    sel.innerHTML = "";
    if (placeholder) {
      const op = document.createElement("option");
      op.value = "";
      op.textContent = placeholder;
      sel.appendChild(op);
    }
    (items || []).forEach((v) => {
      const op = document.createElement("option");
      op.value = v;
      op.textContent = v;
      sel.appendChild(op);
    });
  }

  function statusPill(s) {
    const t = String(s || "").trim();
    let cls = "";
    if (t === "å·²å®Œæˆ") cls = "ok";
    else if (t === "å¾…å›è¦†") cls = "warn";
    else if (t === "å·²è½‰å¤–éƒ¨") cls = "danger";
    return `<span class="${cls}">${esc(t)}</span>`;
  }

  function esc(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  async function api(path) {
    const r = await fetch(path);
    return r.json();
  }
  async function api_init() {
    return api("/callcenter/api/init");
  }
  async function api_list(q = "") {
    return api(`/callcenter/api/list?limit=50&q=${encodeURIComponent(q)}`);
  }

  /* ------- æ¸…å–®æ¸²æŸ“åˆ° Modal ------- */
  function renderHeader() {
    const th = $("thead");
    const ordered = HEADERS.slice();
    const statusIndex = ordered.indexOf("Status");
    const noteIndex = ordered.indexOf("Note");
    if (noteIndex !== -1 && statusIndex !== -1 && noteIndex > statusIndex) {
      ordered.splice(statusIndex, 0, ordered.splice(noteIndex, 1)[0]);
    }
    HEADERS = ordered;
    th.innerHTML =
      `<tr>` + HEADERS.map((h) => `<th>${esc(h)}</th>`).join("") + `</tr>`;
  }

  function renderList(rows) {
    const tb = $("list");
    tb.innerHTML = "";
    $("counter").textContent = rows.length;
    rows.forEach((r) => {
      const tr = document.createElement("tr");
      tr.className = "row";
      tr.innerHTML = HEADERS.map((h) => {
        const v = r[h];
        if (h === "Status") return `<td>${statusPill(v)}</td>`;
        return `<td>${esc(v)}</td>`;
      }).join("");
      tb.appendChild(tr);
    });
  }

  /* ------- äº‹ä»¶èˆ‡åˆå§‹åŒ– ------- */
  function onDeptChange() {
    const dept = $("dept").value;
    const names = (INIT.agentsByDept[dept] || []).map((a) => a);
    fillSelect($("assignee"), names, "è«‹é¸æ“‡");
  }

  // ç°¡æ˜“ debounce
  function debounce(fn, ms = 300) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  async function openModal(loadRecent = true) {
    $("searchModal").style.display = "flex";
    document.body.style.overflow = "hidden";
    if (loadRecent) {
      if (CACHE_RECENT.length) {
        renderList(CACHE_RECENT);
      } else {
        const rows = await api_list("");
        CACHE_RECENT = rows;
        renderList(rows);
      }
    }
    $("q").focus();
  }
  function closeModal() {
    $("searchModal").style.display = "none";
    document.body.style.overflow = "";
  }

  window.addEventListener("load", async () => {
    // è¡¨å–®é è¨­ä»Šå¤©
    $("date").value = new Date().toISOString().slice(0, 10);

    INIT = await api_init();
    HEADERS = INIT.headers || [
      "TicketID",
      "Date",
      "AnswerTime",
      "CallerName",
      "Phone",
      "Issue",
      "Dept",
      "Assignee",
      "Note",
      "Channel",
      "Status",
      "CreatedAt",
    ];
    renderHeader();

    fillSelect($("dept"), INIT.depts, "è«‹é¸æ“‡");
    fillSelect($("channel"), INIT.channels, "è«‹é¸æ“‡");
    fillSelect($("status"), INIT.statuses, "è«‹é¸æ“‡");
    $("dept").addEventListener("change", onDeptChange);

    // é€å–®
    $("ticketForm").addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const fd = new FormData(ev.currentTarget);
      const required = [
        ["date_", "è«‹é¸æ—¥æœŸ"],
        ["answer_time", "è«‹é¸æ™‚é–“"],
        ["channel", "è«‹é¸ä¾†æº"],
        ["issue", "è«‹å¡«è¨´æ±‚"],
      ];
      for (const [k, msg] of required) {
        if (!fd.get(k)) {
          alert(msg);
          return;
        }
      }
      const res = await fetch("/callcenter/api/ticket", {
        method: "POST",
        body: fd,
      });
      const j = await res.json();
      if (j.ok) {
        alert("å·²é€å‡ºï¼TicketIDï¼š" + j.ticketId);
        ev.currentTarget.reset();
        $("date").value = new Date().toISOString().slice(0, 10);
        // é€å–®å¾Œæ›´æ–°å¿«å–çš„æœ€è¿‘ 50 ç­†ï¼ˆè‹¥å·²é–‹éï¼‰
        CACHE_RECENT = await api_list("");
        if ($("searchModal").style.display === "flex") renderList(CACHE_RECENT);
      } else {
        alert("é€å‡ºå¤±æ•—ï¼š" + (j.error || ""));
      }
    });

    // Modal é–‹é—œ
    $("openSearchBtn").addEventListener("click", () => openModal(true));
    $("closeModal").addEventListener("click", closeModal);
    $("closeModal2").addEventListener("click", closeModal);
    $("searchModal").addEventListener("click", (e) => {
      if (e.target === $("searchModal")) closeModal(); // æŒ‰é®ç½©é—œé–‰
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    // æœå°‹
    $("q").addEventListener(
      "input",
      debounce(async (e) => {
        const q = e.target.value.trim();
        if (!q) {
          renderList(CACHE_RECENT);
          return;
        }
        const rows = await api_list(q);
        renderList(rows);
      }, 300)
    );

    // æœ€è¿‘ 50 ç­†
    $("btnRecent").addEventListener("click", async () => {
      $("q").value = "";
      CACHE_RECENT = await api_list("");
      renderList(CACHE_RECENT);
    });
  });
</script>
{% endblock %}
