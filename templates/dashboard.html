{% extends "base.html" %} {% block title %}主控台 - {{ super() }}{% endblock %}
{% block content %}
<!-- 載入儀表盤圖所需的 JavaScript 函式庫 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/justgage/1.4.0/justgage.min.js"></script>

<style>
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
  }
  .dashboard-card {
    background-color: #fff;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
  }
  .dashboard-card h3 {
    margin-top: 0;
    border-bottom: 2px solid #f4f4f4;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  /* KPI 卡片樣式 */
  .kpi-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .kpi-item {
    text-align: center;
  }
  .kpi-item h4 {
    margin: 0 0 0.5rem 0;
    color: #555;
    font-size: 1em;
  }
  .kpi-item p.kpi-subtitle {
    font-size: 0.9em;
    color: #666;
    margin-top: -0.5rem;
    margin-bottom: 1rem;
  }
  .progress-bar {
    width: 100%;
    height: 25px;
    background-color: #e9ecef;
    border-radius: 0.375rem;
    overflow: hidden;
    position: relative;
  }
  .progress-bar-fill {
    height: 100%;
    border-radius: 0.375rem;
    transition: width 0.6s ease;
  }
  .progress-bar-text {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: bold;
    text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
  }
  #gauge {
    width: 100%;
    height: 200px;
  }

  /* --- 公告列表與 Modal 彈跳視窗樣式 --- */
  .announcement-table {
    width: 100%;
    border-collapse: collapse;
  }
  .announcement-table tr {
    border-bottom: 1px solid #eee;
  }
  .announcement-table td {
    padding: 0.8rem 0.2rem;
  }
  .announcement-title-link {
    font-weight: bold;
    color: #337ab7;
    text-decoration: none;
    cursor: pointer;
  }
  .announcement-title-link:hover {
    text-decoration: underline;
  }

  /* Modal 彈跳視窗 */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background-color: #fff;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
  }
  .modal-close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 2rem;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
  }
  .modal-close:hover {
    color: #000;
  }
  .modal-header h2 {
    margin-top: 0;
    color: #337ab7;
  }
  .modal-body {
    margin-top: 1rem;
    line-height: 1.6;
  }
  .modal-meta {
    font-size: 0.85em;
    color: #888;
    margin-top: 1.5rem;
    border-top: 1px solid #eee;
    padding-top: 1rem;
  }
</style>

<!--div class="welcome-card">
  <h2>歡迎來到 <strong>國聯</strong> OneTouch Portal！</h2>
</!--div-->

<div class="dashboard-grid">
  <!-- 左側 KPI 卡片 -->
  <div class="dashboard-card">
    <h3>📊 關鍵績效指標 (KPIs)</h3>
    <div class="kpi-container">
      <!-- ★ 核心修正 1：進度條顯示 "截至今日營收" vs "本月總預算" -->
      <div class="kpi-item">
        <h4>截至今日營收進度</h4>
        {% set mtd_progress = (kpis.mtd_revenue / kpis.monthly_budget * 100) if
        kpis.monthly_budget else 0 %}
        <div class="progress-bar">
          <div
            class="progress-bar-fill"
            style="width: {{ mtd_progress | round(2) }}%; background-color: #5cb85c;"
          ></div>
          <div class="progress-bar-text">
            {{ kpis.mtd_revenue | number }} / {{ kpis.monthly_budget | number }}
          </div>
        </div>
      </div>

      <!-- ★ 核心修正 2：進度條顯示 "昨日營收" vs "每日預算" -->
      <div class="kpi-item">
        <h4>昨日營收進度</h4>
        {% set yesterday_progress = (kpis.yesterday_revenue / kpis.daily_budget
        * 100) if kpis.daily_budget else 0 %}
        <div class="progress-bar">
          <div
            class="progress-bar-fill"
            style="width: {{ yesterday_progress | round(2) }}%; background-color: #007bff;"
          ></div>
          <div class="progress-bar-text">
            {{ kpis.yesterday_revenue | number }} / {{ kpis.daily_budget |
            number }}
          </div>
        </div>
      </div>

      <!-- ★ 核心修正 3：儀表盤顯示 "本月營收達成率" -->
      <div class="kpi-item">
        <h4>本月營收達成率</h4>
        <div id="gauge"></div>
      </div>
    </div>
  </div>

  <!-- 右側公告卡片 -->
  <div class="dashboard-card">
    <h3>📢 最新公告</h3>
    {% if announcements %}
    <table class="announcement-table">
      <tbody>
        {% for ann in announcements %}
        <tr>
          <td>
            <a
              class="announcement-title-link view-announcement-btn"
              data-id="{{ ann.id }}"
            >
              {{ ann.title }}
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>目前沒有任何公告。</p>
    {% endif %}
  </div>
</div>

<!-- Modal 彈跳視窗的 HTML 結構 -->
<div id="announcement-modal" class="modal-overlay">
  <div class="modal-content">
    <span id="modal-close-btn" class="modal-close">&times;</span>
    <div class="modal-header"><h2 id="modal-title"></h2></div>
    <div id="modal-body" class="modal-body"></div>
    <div id="modal-meta" class="modal-meta"></div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // --- 儀表盤圖邏輯 ---
    var mtd_rate = {{ (kpis.mtd_achievement_rate * 100) | round(2) }};
    var gauge_max = mtd_rate > 100 ? mtd_rate : 100;

    var g = new JustGage({
      id: "gauge",
      value: mtd_rate,
      min: 0,
      max: gauge_max,
      title: " ",
      label: "%",
      levelColors: ["#ff0000", "#f9c802", "#a9d70b"],
      formatNumber: true,
      decimals: 2,
      humanFriendlyDecimal: 2,
      pointer: true,
      pointerOptions: {
        toplength: 8,
        bottomlength: 8,
        bottomwidth: 2,
        color: '#8e8e93'
      }
    });

    // --- Modal 彈跳視窗邏輯 ---
    const announcementsData = {{ announcements | tojson }};
    const modal = document.getElementById('announcement-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalMeta = document.getElementById('modal-meta');
    const viewButtons = document.querySelectorAll('.view-announcement-btn');

    viewButtons.forEach(button => {
      button.addEventListener('click', function(event) {
        event.preventDefault();
        const announcementId = parseInt(this.dataset.id, 10);
        const announcement = announcementsData.find(ann => ann.id === announcementId);
        if (announcement) {
          modalTitle.textContent = announcement.title;
          modalBody.innerHTML = announcement.content;
          const timestamp = announcement.timestamp.split('T')[0];
          modalMeta.textContent = `由 ${announcement.author} 發布於 ${timestamp}`;
          modal.style.display = 'flex';
        }
      });
    });

    function closeModal() { modal.style.display = 'none'; }
    modalCloseBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(event) {
      if (event.target === modal) { closeModal(); }
    });
  });
</script>

{% endblock %}
