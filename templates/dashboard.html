{% extends "base.html" %} {% block title %}ä¸»æ§å° - {{ super() }}{% endblock %}
{% block content %}
<!-- è¼‰å…¥å„€è¡¨ç›¤åœ–æ‰€éœ€çš„ JavaScript å‡½å¼åº« -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/justgage/1.4.0/justgage.min.js"></script>

<style>
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
  }
  .dashboard-card {
    background-color: #fff;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
  }
  .dashboard-card h3 {
    margin-top: 0;
    border-bottom: 2px solid #f4f4f4;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  /* KPI å¡ç‰‡æ¨£å¼ */
  .kpi-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .kpi-item {
    text-align: center;
  }
  .kpi-item h4 {
    margin: 0 0 0.5rem 0;
    color: #555;
    font-size: 1em;
  }
  .progress-bar {
    width: 100%;
    height: 25px;
    background-color: #e9ecef;
    border-radius: 0.375rem;
    overflow: hidden;
    position: relative;
  }
  .progress-bar-fill {
    height: 100%;
    background-color: #007bff;
    border-radius: 0.375rem;
    transition: width 0.6s ease;
  }
  .progress-bar-text {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: bold;
    text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
  }
  #gauge {
    width: 100%;
    height: 200px;
  }

  /* --- â˜… æ–°å¢ï¼šå…¬å‘Šåˆ—è¡¨èˆ‡ Modal å½ˆè·³è¦–çª—æ¨£å¼ --- */
  .announcement-table {
    width: 100%;
    border-collapse: collapse;
  }
  .announcement-table tr {
    border-bottom: 1px solid #eee;
  }
  .announcement-table td {
    padding: 0.8rem 0.2rem;
  }
  .announcement-title-link {
    font-weight: bold;
    color: #337ab7;
    text-decoration: none;
    cursor: pointer;
  }
  .announcement-title-link:hover {
    text-decoration: underline;
  }

  /* Modal å½ˆè·³è¦–çª—èƒŒæ™¯ */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: none; /* é è¨­éš±è— */
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  /* Modal å…§å®¹æ¡† */
  .modal-content {
    background-color: #fff;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
  }
  /* Modal é—œé–‰æŒ‰éˆ• */
  .modal-close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 2rem;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
  }
  .modal-close:hover {
    color: #000;
  }
  .modal-header h2 {
    margin-top: 0;
    color: #337ab7;
  }
  .modal-body {
    margin-top: 1rem;
    line-height: 1.6;
  }
  .modal-meta {
    font-size: 0.85em;
    color: #888;
    margin-top: 1.5rem;
    border-top: 1px solid #eee;
    padding-top: 1rem;
  }
</style>

<div class="welcome-card">
  <h2>æ­¡è¿ä¾†åˆ° <strong>åœ‹è¯</strong> OneTouch Portalï¼</h2>
</div>

<div class="dashboard-grid">
  <!-- å·¦å´ KPI å¡ç‰‡ -->
  <div class="dashboard-card">
    <h3>ğŸ“Š é—œéµç¸¾æ•ˆæŒ‡æ¨™ (KPIs)</h3>
    <div class="kpi-container">
      <!-- ç•¶æ—¥ç‡Ÿæ”¶é€²åº¦æ¢ -->
      <div class="kpi-item">
        <h4>ä»Šæ—¥ç‡Ÿæ”¶é€²åº¦</h4>
        {% set day_progress = (kpis.today_revenue / kpis.daily_budget * 100) if
        kpis.daily_budget else 0 %}
        <div class="progress-bar">
          <div
            class="progress-bar-fill"
            style="width: {{ day_progress | round(2) }}%;"
          ></div>
          <div class="progress-bar-text">
            {{ kpis.today_revenue | number }} / {{ kpis.daily_budget | number }}
          </div>
        </div>
      </div>
      <!-- æœ¬æœˆé”æˆç‡å„€è¡¨ç›¤ -->
      <div class="kpi-item">
        <h4>æœ¬æœˆç‡Ÿæ”¶é”æˆç‡</h4>
        <div id="gauge"></div>
      </div>
    </div>
  </div>

  <!-- å³å´å…¬å‘Šå¡ç‰‡ -->
  <div class="dashboard-card">
    <h3>ğŸ“¢ æœ€æ–°å…¬å‘Š</h3>
    {% if announcements %}
    <table class="announcement-table">
      <tbody>
        {% for ann in announcements %}
        <tr>
          <td>
            <!-- â˜… æ ¸å¿ƒä¿®æ­£ï¼šæŒ‰éˆ•åªå„²å­˜å…¬å‘Šçš„ ID -->
            <a
              class="announcement-title-link view-announcement-btn"
              data-id="{{ ann.id }}"
            >
              {{ ann.title }}
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>ç›®å‰æ²’æœ‰ä»»ä½•å…¬å‘Šã€‚</p>
    {% endif %}
  </div>
</div>

<!-- Modal å½ˆè·³è¦–çª—çš„ HTML çµæ§‹ (ç¶­æŒä¸è®Š) -->
<div id="announcement-modal" class="modal-overlay">
  <div class="modal-content">
    <span id="modal-close-btn" class="modal-close">&times;</span>
    <div class="modal-header">
      <h2 id="modal-title"></h2>
    </div>
    <div id="modal-body" class="modal-body"></div>
    <div id="modal-meta" class="modal-meta"></div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // --- å„€è¡¨ç›¤åœ–é‚è¼¯ (ç¶­æŒä¸è®Š) ---
    var mtd_rate = {{ (kpis.mtd_achievement_rate * 100) | round(2) }};
    var g = new JustGage({
      id: "gauge", value: mtd_rate, min: 0, max: 100, title: " ", label: "%",
      levelColors: ["#ff0000", "#f9c802", "#a9d70b"],
      formatNumber: true, decimals: 2, humanFriendlyDecimal: 2
    });

    // --- â˜… æ ¸å¿ƒä¿®æ­£ï¼šModal å½ˆè·³è¦–çª—é‚è¼¯ ---

    // 1. å°‡å¾Œç«¯å‚³ä¾†çš„å®Œæ•´å…¬å‘Šè³‡æ–™ï¼Œå„²å­˜åœ¨ JavaScript è®Šæ•¸ä¸­
    //    ä½¿ç”¨ tojson éæ¿¾å™¨å¯ä»¥å®‰å…¨åœ°å°‡ Python ç‰©ä»¶è½‰æ›ç‚º JSON å­—ä¸²
    const announcementsData = {{ announcements | tojson }};

    const modal = document.getElementById('announcement-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalMeta = document.getElementById('modal-meta');
    const viewButtons = document.querySelectorAll('.view-announcement-btn');

    // 2. ç‚ºæ‰€æœ‰å…¬å‘Šæ¨™é¡ŒåŠ ä¸Šé»æ“Šäº‹ä»¶
    viewButtons.forEach(button => {
      button.addEventListener('click', function(event) {
        event.preventDefault();
        // 3. å¾æŒ‰éˆ•å–å¾—å…¬å‘Šçš„ ID
        const announcementId = parseInt(this.dataset.id, 10);

        // 4. æ ¹æ“š ID å¾æˆ‘å€‘å„²å­˜çš„å®Œæ•´è³‡æ–™ä¸­æ‰¾åˆ°å°æ‡‰çš„å…¬å‘Š
        const announcement = announcementsData.find(ann => ann.id === announcementId);

        if (announcement) {
          // 5. å°‡æ‰¾åˆ°çš„è³‡æ–™å¡«å…¥ Modal
          modalTitle.textContent = announcement.title;
          modalBody.innerHTML = announcement.content; // ä½¿ç”¨ innerHTML ä¾†æ¸²æŸ“ HTML æ ¼å¼
          const timestamp = announcement.timestamp.split('T')[0];
          modalMeta.textContent = `ç”± ${announcement.author} ç™¼å¸ƒæ–¼ ${timestamp}`;

          // é¡¯ç¤º Modal
          modal.style.display = 'flex';
        }
      });
    });

    // é—œé–‰ Modal çš„å‡½å¼
    function closeModal() {
      modal.style.display = 'none';
    }

    // é»æ“Šé—œé–‰æŒ‰éˆ•æ™‚ï¼Œé—œé–‰ Modal
    modalCloseBtn.addEventListener('click', closeModal);

    // é»æ“Š Modal èƒŒæ™¯é®ç½©æ™‚ï¼Œä¹Ÿé—œé–‰ Modal
    modal.addEventListener('click', function(event) {
      if (event.target === modal) {
        closeModal();
      }
    });
  });
</script>

{% endblock %}
