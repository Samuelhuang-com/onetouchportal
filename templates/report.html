{% extends "base.html" %}
{% block title %}ç‡Ÿæ¥­æ—¥èªŒ - {{ super() }}{% endblock %}
{% block content %}
<style>
  .responsive-table {
    overflow-x: auto;
    width: 100%;
    margin-top: 0rem;
    border-collapse: collapse;
  }
  .responsive-table th,
  .responsive-table td {
    white-space: nowrap;
    padding: 8px 12px;
    border: 1px solid #ddd;
  }
  .form-inline {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 0rem;
  }
  h2, h3 {
    margin-top: 0;
    margin-bottom: 0rem;
  }
</style>

<form method="get" action="/report" class="form-inline" id="reportForm">
  <label for="date">é¸æ“‡æ—¥æœŸï¼š</label>
  <select name="date" id="date"
          onchange="document.getElementById('reportForm').submit();"
          style="padding:6px 10px;border:1px solid #ccc;border-radius:4px;">
    {% for d in available_dates %}
      <option value="{{ d }}" {% if d == report_date %}selected{% endif %}>{{ d }}</option>
    {% endfor %}
  </select>
  <button type="button" class="button" onclick="selectToday()">ğŸ“… ä»Šå¤©</button>
  <button type="button" class="button" onclick="selectMonth()">ğŸ“† æœ¬æœˆ</button>
</form>

<script>
  function selectToday() {
    const today = new Date().toISOString().slice(0,10);
    const dropdown = document.getElementById('date');
    for (let opt of dropdown.options) {
      if (opt.value === today) {
        dropdown.value = today;
        document.getElementById('reportForm').submit();
        return;
      }
    }
    alert("âš ï¸ ä»Šæ—¥å°šç„¡å ±è¡¨è³‡æ–™");
  }
  function selectMonth() {
    const dropdown = document.getElementById('date');
    if (dropdown.options.length > 0) {
      dropdown.selectedIndex = dropdown.options.length - 1;
      document.getElementById('reportForm').submit();
    }
  }
</script>

{% if report_date %}
<style>
  .report-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 10px; /* å–®å…ƒæ ¼ä¹‹é–“çš„é–“è· */
  }
  .report-table td {
    min-width: 250px;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 5px;
    vertical-align: top;
  }
</style>

<table class="report-table">
  <tr>
    <td style="border-left:5px solid #3c8dbc;">
      <strong>ğŸ“… æœ¬æœˆé ç®—/å¤©æ•¸<br>{{ budgets.mtd_revenue | number }}</strong>
    </td>
    <td style="border-left:5px solid #00a65a;">
      <strong>ğŸ“ˆ æ¯æ—¥ç‡Ÿæ”¶é ç®—<br>{{ budgets.day_revenue | number }}</strong>
    </td>
    <td style="border-left:5px solid #f39c12;">
      <strong>ğŸ· æœ¬æœˆé…’æ°´é ç®—<br>{{ budgets.mtd_bev | number }}</strong>
    </td>
    <td style="border-left:5px solid #605ca8;">
      <strong>ğŸ¥‚ æ¯æ—¥é…’æ°´é ç®—<br>{{ budgets.day_bev | number }}</strong>
    </td>
  </tr>
  <tr>
    <td style="border-left:5px solid #0073b7;">
      <strong>ğŸ“Š ç›®å‰ç´¯è¨ˆæ”¶å…¥<br>{{ mtd_revenue }}</strong>
    </td>
    <td style="border-left:5px solid #00c0ef;">
      <strong>ğŸ“ˆ æœ¬æœˆé”æˆç‡<br>{{ rates.mtd_rate | percent }}</strong>
    </td>
    <td style="border-left:5px solid #d81b60;">
      <strong>ğŸ“‰ ç´¯è¨ˆé”æˆç‡<br>{{ rates.accumulated_mtd_rate | percent }}</strong>
    </td>
    <td style="border-left:5px solid #39cccc;">
      <strong>ğŸ¹ é…’æ°´é”æˆç‡<br>{{ rates.bev_rate | percent }}</strong>
    </td>
  </tr>
</table>

<hr>
<h3>ğŸ“… å ±è¡¨æ—¥æœŸï¼š{{ report_date }}ã€€ğŸ“{{ branch }}</h3>
<div class="responsive-table">
  <table>
    <thead>
      <tr>
        <th>é¤åˆ¥</th><th>ä¾†å®¢æ•¸</th><th>é¤é£Ÿæ”¶å…¥</th>
        <th>é£²æ–™æ”¶å…¥</th><th>å…¶ä»–æ”¶å…¥</th><th>æœå‹™è²»</th>
        <th>ç¸½æ”¶å…¥</th><th>å¹³å‡æ¶ˆè²»</th>
      </tr>
    </thead>
    <tbody>
      {% for r in records %}
      <tr>
        <td>{{ r.Meal }} {{ r.Meal_Chinese }}</td>
        <td align="right">{{ r.Covers }}</td>
        <td align="right">{{ r.FoodRev }}</td>
        <td align="right">{{ r.BevRev }}</td>
        <td align="right">{{ r.OthersRev }}</td>
        <td align="right">{{ r.SvcCharge }}</td>
        <td align="right">{{ r.TotalFB }}</td>
        <td align="right">{{ r.AvgCheck }}</td>
      </tr>
      {% endfor %}
      <tr style="font-weight:bold;background:#f0f0f0;">
        <td>Total ç¸½è¨ˆ</td>
        <td align="right">{{ totals.Covers }}</td>
        <td align="right">{{ totals.FoodRev }}</td>
        <td align="right">{{ totals.BevRev }}</td>
        <td align="right">{{ totals.OthersRev }}</td>
        <td align="right">{{ totals.SvcCharge }}</td>
        <td align="right">{{ totals.TotalFB }}</td>
        <td align="right">{{ totals.AvgCheck }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div style="margin-top:20px;">
  <strong>MTD æœˆç´¯è¨ˆæ”¶å…¥ï¼š</strong>{{ mtd_revenue }}ã€€
  <strong>æœ¬æœˆé”æˆç‡ï¼š</strong>{{ rates.mtd_rate | percent }}ã€€
  <strong>æœ¬æœˆç´¯è¨ˆé”æˆç‡ï¼š</strong>{{ rates.accumulated_mtd_rate | percent }}ã€€
  <strong>æ¯æ—¥é”æˆç‡ï¼š</strong>{{ rates.day_rate | percent }}ã€€
  <strong>é…’æ°´é”æˆç‡ï¼š</strong>{{ rates.bev_rate | percent }}
</div>

{% if chart_data %}
<canvas id="revenueChart" height="100"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('revenueChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ chart_data.labels | tojson }},
      datasets: [
        { label: 'æ¯æ—¥ç¸½æ”¶å…¥', data: {{ chart_data.total | tojson }}, tension:0.3 },
        { label: 'å¹³å‡æ¶ˆè²»', data: {{ chart_data.avgcheck | tojson }}, borderDash:[5,5], yAxisID:'y1' }
      ]
    },
    options:{
      responsive:true,
      scales:{
        y:{ title:{display:true,text:'æ”¶å…¥ (å…ƒ)'} },
        y1:{ position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'å¹³å‡æ¶ˆè²»'} }
      },
      plugins:{ legend:{position:'bottom'} }
    }
  });
</script>
{% endif %}
{% endif %}
{% endblock %}
