{% extends "base.html" %}
{% block title %}角色權限 - {{ super() if super else "OneTouch" }}{% endblock %}
{% block content %}
<style>
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid #e5e7eb;padding:8px}
.table th{background:#f9fafb;text-align:left;position:sticky;top:0}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:16px}
.controls{display:flex;gap:8px;align-items:center}
</style>

<div class="card">
  <h2>🧩 角色清單</h2>
  <form method="post" action="/admin/roles/add" class="controls">
    新增角色：
    <input name="name" placeholder="manager" required>
    <input name="display_name" placeholder="顯示名稱">
    <button type="submit">➕ 新增</button>
  </form>
</div>

<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>角色</th><th>顯示名稱</th>
        {% for k in perm_keys %}<th>{{k}}</th>{% endfor %}
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for row in roles %}
      {% set r = row.role %}{% set perms = row.perms %}
      <tr>
        <form method="post" action="/admin/roles/update_perms" onsubmit="return packPerms(this, permKeys)">
          <td><strong>{{r.name}}</strong>
            <input type="hidden" name="role_id" value="{{r.id}}">
            <input type="hidden" name="role_name" value="{{r.name}}">
          </td>
          <td>{{r.display_name or ""}}</td>

          {% for k in perm_keys %}
          <td style="text-align:center">
            <input type="checkbox" name="perm_{{k}}" value="1" {{ 'checked' if perms[k]==1 else '' }}>
          </td>
          {% endfor %}

          <td class="controls">
            <input type="hidden" name="perms_json">
            <button type="submit">💾 儲存</button>
        </form>
        <form method="post" action="/admin/roles/delete" style="display:inline" onsubmit="return confirm('刪除此角色？')">
          <input type="hidden" name="role_id" value="{{r.id}}">
          <input type="hidden" name="role_name" value="{{r.name}}">
          <button type="submit">🗑 刪除</button>
        </form>
          </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
const permKeys = {{ perm_keys|tojson }};
</script>
{% include "admin/_perm_pack_js.html" %}
{% endblock %}
