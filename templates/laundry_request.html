<!-- templates/laundry_request.html -->
{% extends "base.html" %} {% block title %}æ´—è¡£æˆ¿é€æ´—ç™»è¨˜ - {{ super() }}{%
endblock %} {% block content %}
<div class="page-header"><h2>æ´—è¡£æˆ¿é€æ´—ç™»è¨˜</h2></div>

{% if error %}
<div class="alert alert-danger"><strong>éŒ¯èª¤ï¼š</strong> {{ error }}</div>
{% endif %}

<!-- æä¾›çµ„ç¹”æŠ¬é ­è¨­å®šï¼ˆJS æœƒè®€å–é€™è£¡çš„ data-*ï¼‰ -->
<!--div
  id="org-config"
  data-company-name="{{ company_name if company_name is defined else 'OneTouch Portal' }}"
  data-logo-url="{{ company_logo_url if company_logo_url is defined else '' }}"
></!--div-->
<div
  id="org-config"
  data-company-name="{{ company_name if company_name is defined else '' }}"
  data-logo-url="{{ company_logo_url if company_logo_url is defined else '' }}"
></div>
<div class="form-container card">
  <form id="laundry-form" action="/laundry/request" method="post">
    <div class="form-grid">
      <div class="form-group">
        <label for="date">é€æ´—æ—¥æœŸ</label>
        <input type="date" id="date" name="date" value="{{ today }}" required />
      </div>
      <div class="form-group">
        <label for="employee_id">å“¡å·¥ç·¨è™Ÿ</label>
        <input
          type="text"
          id="employee_id"
          name="employee_id"
          placeholder="è«‹è¼¸å…¥æ‚¨çš„å“¡å·¥ç·¨è™Ÿ"
          required
        />
        <small id="employee-info" class="employee-info-display"></small>
      </div>
    </div>

    <hr />
    <h4>é€æ´—é …ç›®èˆ‡æ•¸é‡</h4>
    <div class="laundry-items-grid">
      {% for item in clothing_items %}
      <div class="laundry-item">
        <label for="quantity_{{ item }}">{{ item }}</label>
        <input
          type="number"
          id="quantity_{{ item }}"
          name="quantity_{{ item }}"
          min="0"
          value="0"
        />
      </div>
      {% endfor %}
    </div>

    <div class="form-actions">
      <button type="submit" class="button button-primary">æäº¤ç™»è¨˜</button>
    </div>
  </form>
</div>

<!-- æˆåŠŸè¦–çª—ï¼ˆé è¦½èˆ‡åˆ—å°ï¼‰ -->
<div
  id="success-modal"
  class="modal-overlay hidden"
  aria-modal="true"
  role="dialog"
>
  <div class="modal-content" role="document">
    <div class="modal-header">
      <h3>âœ… è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼</h3>
      <button id="close-modal-btn" class="close-button" aria-label="é—œé–‰">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <p>æ‚¨å¯ä»¥åˆ—å°æœ¬æ¬¡çš„é€æ´—æ”¶æ“šï¼Œæˆ–é—œé–‰æ­¤è¦–çª—ä»¥ç¹¼çºŒç™»è¨˜ã€‚</p>

      <!-- é è¦½ç”¨çš„æ”¶æ“šå€å¡Šï¼ˆåˆ—å°å‰æœƒè¤‡è£½åˆ° #print-rootï¼‰ -->
      <div id="print-area"></div>

      <!-- é™¤éŒ¯ JSONï¼šé è¨­éš±è—ï¼Œç¶²å€å¸¶ ?debug=1 æœƒé¡¯ç¤º -->
      <pre
        id="debug-json"
        style="
          display: none;
          background: #f8f9fa;
          border: 1px dashed #dee2e6;
          padding: 0.75rem;
          margin-top: 1rem;
          max-height: 220px;
          overflow: auto;
        "
      ></pre>
    </div>
    <div class="modal-footer">
      <button id="print-btn" class="button">ğŸ–¨ï¸ åˆ—å°æ”¶æ“š</button>
      <button id="close-modal-footer-btn" class="button button-secondary">
        é—œé–‰
      </button>
    </div>
  </div>
</div>

<!-- åˆ—å°å°ˆç”¨å®¹å™¨ï¼ˆåƒ…åˆ—å°æ™‚é¡¯ç¤ºï¼‰ -->
<div id="print-root" aria-hidden="true"></div>

<style>
  .form-container {
    max-width: 900px;
    margin: 0 auto;
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .laundry-items-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 1rem;
  }
  .laundry-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f8f9fa;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e9ecef;
  }
  .laundry-item input[type="number"] {
    width: 72px;
    text-align: center;
  }
  .form-actions {
    text-align: right;
    margin-top: 25px;
  }
  .alert-danger {
    color: #721c24;
    background: #f8d7da;
    border-color: #f5c6cb;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 4px;
  }
  .employee-info-display {
    margin-top: 8px;
    padding: 8px 12px;
    background: #e9ecef;
    border-radius: 4px;
    color: #495057;
    border: 1px solid #ced4da;
  }
  .employee-info-display.error {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 1;
    transition: opacity 0.2s;
  }
  .modal-overlay.hidden {
    opacity: 0;
    pointer-events: none;
    display: none;
  }
  .modal-content {
    background: #fff;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    width: 90%;
    max-width: 560px;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
  }
  .close-button {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: #6c757d;
  }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    border-top: 1px solid #e9ecef;
    padding-top: 1rem;
    margin-top: 1rem;
  }
  .button-secondary {
    background: #6c757d;
    color: #fff;
  }

  /* æ”¶æ“šæ¨£å¼ï¼ˆç•«é¢ï¼‰ */
  #print-area {
    border: 1px dashed #adb5bd;
    padding: 1.5rem;
    margin-top: 1rem;
    background: #fff;
    font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial,
      sans-serif;
  }
  .receipt-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 10px;
  }
  .receipt-logo {
    width: 44px;
    height: 44px;
    object-fit: contain;
  }
  .receipt-title {
    display: flex;
    flex-direction: row; /* æ©«å‘æ’åˆ—ï¼šorg-name åœ¨å·¦ã€h4 åœ¨å³ */
    align-items: center; /* å‚ç›´ç½®ä¸­ï¼ˆç›¸å°æ–¼ logo ä¹Ÿæœƒç½®ä¸­ï¼‰ */
    gap: 12px; /* å·¦å³é–“è· */
  }
  .receipt-title .org-name {
    font-weight: 700;
    font-size: 16px;
    line-height: 1;
  }
  .receipt-title h4 {
    font-size: 18px;
    margin: 0; /* èˆ‡ org-name å°é½Š */
    text-align: left;
    align-items: center;
  }
  .receipt-hr {
    border: none;
    border-top: 2px solid #343a40;
    margin: 6px 0 14px 0;
  }

  #print-area .print-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  #print-area table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
    table-layout: fixed;
  }
  #print-area th,
  #print-area td {
    border: 1px solid #dee2e6;
    padding: 8px;
    text-align: left;
    word-break: break-all;
  }
  #print-area th {
    background: #f1f3f5;
  }

  /* åªåˆ—å° #print-rootï¼ˆvisibility æ³•ï¼‰ */
  @media print {
    @page {
      margin: 12mm;
    }
    html,
    body {
      margin: 0 !important;
      padding: 0 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    body * {
      visibility: hidden !important;
    }
    #print-root,
    #print-root * {
      visibility: visible !important;
    }
    #print-root {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      border: 0 !important;
      box-shadow: none !important;
      transform: none !important;
    }
    #print-root table {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    #print-root tr,
    #print-root td,
    #print-root th {
      page-break-inside: avoid;
      break-inside: avoid;
    }
  }

  @media (max-width: 768px) {
    .laundry-items-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 480px) {
    .laundry-items-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("laundry-form");
    const modal = document.getElementById("success-modal");
    const printBtn = document.getElementById("print-btn");
    const closeModalBtns = [
      document.getElementById("close-modal-btn"),
      document.getElementById("close-modal-footer-btn"),
    ];
    const printArea = document.getElementById("print-area");
    const printRoot = document.getElementById("print-root");
    const employeeIdInput = document.getElementById("employee_id");
    const employeeInfoDisplay = document.getElementById("employee-info");
    const debugPre = document.getElementById("debug-json");

    // çµ„ç¹”æŠ¬é ­è¨­å®š
    const orgEl = document.getElementById("org-config");
    const ORG_NAME = orgEl?.dataset.companyName || "";
    const ORG_LOGO = orgEl?.dataset.logoUrl || "/static/logo_brown02.png";

    // å–å¾—å“¡å·¥è³‡æ–™
    async function fetchEmployeeInfo() {
      const employeeId = employeeIdInput.value.trim();
      employeeInfoDisplay.textContent = "";
      employeeInfoDisplay.classList.remove("error");
      employeeInfoDisplay.dataset.name = "";
      employeeInfoDisplay.dataset.department = "";
      if (!employeeId) return;

      try {
        const resp = await fetch(`/api/employee/${employeeId}`);
        const txt = await resp.text();
        let data = {};
        try {
          data = JSON.parse(txt);
        } catch (e) {}
        if (resp.ok) {
          employeeInfoDisplay.textContent = `å§“å: ${data.name} / éƒ¨é–€: ${data.department}`;
          employeeInfoDisplay.dataset.name = data.name || "";
          employeeInfoDisplay.dataset.department = data.department || "";
        } else {
          employeeInfoDisplay.textContent = (data && data.detail) || "æŸ¥è©¢å¤±æ•—";
          employeeInfoDisplay.classList.add("error");
        }
      } catch (err) {
        employeeInfoDisplay.textContent = "æŸ¥è©¢æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤";
        employeeInfoDisplay.classList.add("error");
      }
    }
    employeeIdInput.addEventListener("blur", fetchEmployeeInfo);

    // é€å‡ºå‰å°‡åˆ—å°æ‰€éœ€è³‡æ–™å­˜å…¥ sessionStorage
    form.addEventListener("submit", () => {
      const items = [];
      form
        .querySelectorAll('.laundry-item input[type="number"]')
        .forEach((input) => {
          const q = parseInt(input.value || "0", 10);
          if (q > 0)
            items.push({
              name: input.previousElementSibling.innerText,
              quantity: q,
            });
        });
      const dataToStore = {
        employeeId: employeeIdInput.value,
        employeeName: employeeInfoDisplay.dataset.name || "",
        department: employeeInfoDisplay.dataset.department || "",
        date: document.getElementById("date").value,
        items,
      };
      sessionStorage.setItem("lastLaundryData", JSON.stringify(dataToStore));
    });

    // å»ºç«‹æ”¶æ“šï¼ˆå«æŠ¬é ­èˆ‡ Logoï¼‰
    function buildReceiptFrom(data) {
      // é™¤éŒ¯ JSON åƒ…åœ¨ ?debug=1 é¡¯ç¤º
      const urlParams = new URLSearchParams(window.location.search);
      if (debugPre)
        debugPre.style.display =
          urlParams.get("debug") === "1" ? "block" : "none";
      if (debugPre && urlParams.get("debug") === "1") {
        debugPre.textContent = JSON.stringify(data, null, 2);
      }

      if (!data || !Array.isArray(data.items) || data.items.length === 0) {
        printArea.innerHTML = `<p style="color:#d6336c">æ²’æœ‰å¯åˆ—å°çš„é …ç›®ï¼ˆitems ç‚ºç©ºï¼‰ã€‚</p>`;
        return;
      }

      const header = `
      <div class="receipt-header">
        ${
          ORG_LOGO
            ? `<img src="${ORG_LOGO}" alt="${ORG_NAME} logo" class="receipt-logo">`
            : ""
        }
        <div class="receipt-title">
          <div class="org-name">${ORG_NAME}</div>
          <h4>æ´—è¡£é€æ´—æ”¶æ“š</h4>
        </div>
      </div>
      <hr class="receipt-hr">
    `;

      let body = `
      <div class="print-info">
        <span><strong>éƒ¨é–€:</strong> ${data.department || "-"}</span>
        <span><strong>é€æ´—æ—¥æœŸ:</strong> ${data.date || "-"}</span>
      </div>
      <div class="print-info">
        <span><strong>å“¡å·¥:</strong> ${data.employeeName || "-"} (${
        data.employeeId || "-"
      })</span>
        <span></span>
      </div>
      <table>
        <thead><tr><th>é …ç›®</th><th>æ•¸é‡</th></tr></thead>
        <tbody>`;

      data.items.forEach((it) => {
        body += `<tr><td>${it.name}</td><td>${it.quantity}</td></tr>`;
      });
      body += `</tbody></table>`;

      printArea.innerHTML = header + body;
    }

    // æˆåŠŸå›ä¾† â†’ é¡¯ç¤ºé è¦½
    const urlParams = new URLSearchParams(window.location.search);
    const stored = sessionStorage.getItem("lastLaundryData");
    if (urlParams.has("success") || urlParams.get("debug") === "1") {
      if (stored) {
        buildReceiptFrom(JSON.parse(stored));
        modal.classList.remove("hidden");
        if (urlParams.has("success")) {
          sessionStorage.removeItem("lastLaundryData");
          history.replaceState(null, "", window.location.pathname);
        }
      }
    }

    /* åˆ—å°ï¼ˆæŒ‰éˆ•èˆ‡ Ctrl+Pï¼‰ */
    function populatePrintRoot() {
      const html = printArea?.innerHTML?.trim() || "";
      if (!html) return;
      printRoot.setAttribute("aria-hidden", "false");
      printRoot.innerHTML = "";
      const clone = printArea.cloneNode(true);
      clone.style.border = "none";
      clone.style.margin = "0";
      clone.style.padding = "0";
      printRoot.appendChild(clone);
    }
    function cleanupAfterPrint() {
      setTimeout(() => {
        printRoot.innerHTML = "";
      }, 0);
    }

    function printOnSamePage() {
      populatePrintRoot();
      if (!printRoot.innerHTML.trim()) {
        alert("æ²’æœ‰å¯åˆ—å°çš„å…§å®¹ã€‚è«‹å…ˆæäº¤ä¸€æ¬¡è¡¨å–®ç”¢ç”Ÿæ”¶æ“šã€‚");
        return;
      }
      window.print();
      cleanupAfterPrint();
    }
    printBtn?.addEventListener("click", printOnSamePage);
    window.addEventListener("beforeprint", populatePrintRoot);
    window.addEventListener("afterprint", cleanupAfterPrint);
    const mq = window.matchMedia("print");
    if (mq && mq.addEventListener) {
      mq.addEventListener("change", (e) => {
        if (e.matches) populatePrintRoot();
        else cleanupAfterPrint();
      });
    }

    /* é—œé–‰è¦–çª—ï¼ˆå‰å‰ / é—œé–‰éˆ• / é»é®ç½© / ESCï¼‰ */
    function closeModal() {
      modal.classList.add("hidden");
      modal.style.display = "none";
    }
    closeModalBtns.forEach((btn) => btn?.addEventListener("click", closeModal));
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !modal.classList.contains("hidden"))
        closeModal();
    });
  });
</script>
{% endblock %}
