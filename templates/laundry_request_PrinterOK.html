<!-- templates/laundry_request.html -->
{% extends "base.html" %} {% block title %}æ´—è¡£æˆ¿é€æ´—ç™»è¨˜ - {{ super() }}{%
endblock %} {% block content %}
<div class="page-header">
  <h2>æ´—è¡£æˆ¿é€æ´—ç™»è¨˜</h2>
</div>

{% if error %}
<div class="alert alert-danger"><strong>éŒ¯èª¤ï¼š</strong> {{ error }}</div>
{% endif %}

<div class="form-container card">
  <form id="laundry-form" action="/laundry/request" method="post">
    <div class="form-grid">
      <div class="form-group">
        <label for="date">é€æ´—æ—¥æœŸ</label>
        <input type="date" id="date" name="date" value="{{ today }}" required />
      </div>
      <div class="form-group">
        <label for="employee_id">å“¡å·¥ç·¨è™Ÿ</label>
        <input
          type="text"
          id="employee_id"
          name="employee_id"
          placeholder="è«‹è¼¸å…¥æ‚¨çš„å“¡å·¥ç·¨è™Ÿ"
          required
        />
        <small id="employee-info" class="employee-info-display"></small>
      </div>
    </div>

    <hr />

    <h4>é€æ´—é …ç›®èˆ‡æ•¸é‡</h4>
    <div class="laundry-items-grid">
      {% for item in clothing_items %}
      <div class="laundry-item">
        <label for="quantity_{{ item }}">{{ item }}</label>
        <input
          type="number"
          id="quantity_{{ item }}"
          name="quantity_{{ item }}"
          min="0"
          value="0"
        />
      </div>
      {% endfor %}
    </div>

    <div class="form-actions">
      <button type="submit" class="button button-primary">æäº¤ç™»è¨˜</button>
    </div>
  </form>
</div>

<!-- æˆåŠŸè¨Šæ¯å½ˆå‡ºè¦–çª— -->
<div id="success-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>âœ… è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼</h3>
      <button id="close-modal-btn" class="close-button">&times;</button>
    </div>
    <div class="modal-body">
      <p>æ‚¨å¯ä»¥åˆ—å°æœ¬æ¬¡çš„é€æ´—æ”¶æ“šï¼Œæˆ–é—œé–‰æ­¤è¦–çª—ä»¥ç¹¼çºŒç™»è¨˜ã€‚</p>
      <!-- ç•«é¢é¡¯ç¤ºç”¨çš„æ”¶æ“šå€å¡Šï¼ˆåˆ—å°æ™‚æœƒè¢«è¤‡è£½åˆ° #print-rootï¼‰ -->
      <div id="print-area"></div>
      <pre
        id="debug-json"
        style="
          background: #f8f9fa;
          border: 1px dashed #dee2e6;
          padding: 0.75rem;
          margin-top: 1rem;
          max-height: 220px;
          overflow: auto;
        "
      ></pre>
    </div>
    <div class="modal-footer">
      <button id="print-btn" class="button">ğŸ–¨ï¸ åˆ—å°æ”¶æ“š</button>
      <button id="close-modal-footer-btn" class="button button-secondary">
        é—œé–‰
      </button>
    </div>
  </div>
</div>

<!-- åˆ—å°å°ˆç”¨å®¹å™¨ï¼ˆå¹³å¸¸éš±è—ï¼Œåˆ—å°æ™‚åªè¼¸å‡ºé€™ä¸€å¡Šï¼‰ -->
<div id="print-root" aria-hidden="true"></div>

<style>
  .form-container {
    max-width: 900px;
    margin: 0 auto;
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .laundry-items-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 1rem;
  }
  .laundry-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f8f9fa;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e9ecef;
    transition: box-shadow 0.2s;
  }
  .laundry-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }
  .laundry-item input[type="number"] {
    width: 70px;
    text-align: center;
    padding: 0.375rem 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1rem;
  }
  .form-actions {
    margin-top: 25px;
    text-align: right;
  }
  .alert-danger {
    color: #721c24;
    background: #f8d7da;
    border-color: #f5c6cb;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 4px;
  }

  .employee-info-display {
    margin-top: 8px;
    padding: 8px 12px;
    background: #e9ecef;
    border-radius: 4px;
    color: #495057;
    font-weight: 500;
    min-height: 22px;
    border: 1px solid #ced4da;
  }
  .employee-info-display.error {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 1;
    transition: opacity 0.3s;
  }
  .modal-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }
  .modal-content {
    background: #fff;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 520px;
    transform: scale(1);
    transition: transform 0.3s;
  }
  .modal-overlay.hidden .modal-content {
    transform: scale(0.9);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
  }
  .close-button {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: #6c757d;
  }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
    margin-top: 1rem;
  }
  .button-secondary {
    background: #6c757d;
    color: #fff;
  }

  .modal-overlay.hidden {
    opacity: 0;
    pointer-events: none;
    display: none; /* æ–°å¢é€™è¡Œ */
  }

  /* æ”¶æ“šè¦–è¦ºæ¨£å¼ï¼ˆç•«é¢ç”¨ï¼‰ */
  #print-area {
    border: 1px dashed #adb5bd;
    padding: 1.5rem;
    margin-top: 1rem;
    font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial,
      sans-serif;
    background: #fff;
  }
  #print-area h4 {
    text-align: center;
    margin: 0 0 0.75rem 0;
  }
  #print-area .print-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
  }
  #print-area table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
    table-layout: fixed;
  }
  #print-area th,
  #print-area td {
    border: 1px solid #dee2e6;
    padding: 8px;
    text-align: left;
    word-break: break-all;
  }
  #print-area th {
    background: #f1f3f5;
  }

  /* ========= åˆ—å°ï¼šåªè¼¸å‡º #print-rootï¼Œå…¶ä»–å…¨éš±è— ========= */
  /* ========= åˆ—å°ï¼šåªè¼¸å‡º #print-rootï¼Œå…¶ä»–ä»¥ visibility éš±è— ========= */
  @media print {
    @page {
      margin: 12mm;
    }
    html,
    body {
      margin: 0 !important;
      padding: 0 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* å…ˆæŠŠæ•´é éš±è—ï¼Œä½†ä¸æ”¹è®Šæ’ç‰ˆæµï¼Œé¿å…ç©ºç™½é æˆ–é‚„åŸå¤±æ•— */
    body * {
      visibility: hidden !important;
    }

    /* åªé¡¯ç¤º #print-root èˆ‡å…¶å­å…ƒç´  */
    #print-root,
    #print-root * {
      visibility: visible !important;
    }

    /* æŠŠ #print-root æ”¾åˆ°é é¢å·¦ä¸Šè§’é‹ªæ»¿å¯¬åº¦ï¼Œç¢ºä¿ä¸€å®šçœ‹å¾—åˆ° */
    #print-root {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      border: 0 !important;
      box-shadow: none !important;
      transform: none !important;
    }

    /* é¿å…è¡¨æ ¼è¢«æ‹†é  */
    #print-root table {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    #print-root tr,
    #print-root td,
    #print-root th {
      page-break-inside: avoid;
      break-inside: avoid;
    }
  }

  @media (max-width: 768px) {
    .laundry-items-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 480px) {
    .laundry-items-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    console.log("ğŸ”§ [DEBUG] DOM å·²å°±ç·’");
    const form = document.getElementById("laundry-form");
    const modal = document.getElementById("success-modal");
    const printBtn = document.getElementById("print-btn");
    const closeModalBtns = [
      document.getElementById("close-modal-btn"),
      document.getElementById("close-modal-footer-btn"),
    ];
    const printArea = document.getElementById("print-area");
    const printRoot = document.getElementById("print-root");
    const employeeIdInput = document.getElementById("employee_id");
    const employeeInfoDisplay = document.getElementById("employee-info");
    const debugPre = document.getElementById("debug-json");

    // å–å¾—å“¡å·¥è³‡è¨Šï¼ˆè¼¸å…¥æ¡†é›¢é–‹æ™‚ï¼‰
    async function fetchEmployeeInfo() {
      const employeeId = employeeIdInput.value.trim();
      employeeInfoDisplay.textContent = "";
      employeeInfoDisplay.classList.remove("error");
      employeeInfoDisplay.dataset.name = "";
      employeeInfoDisplay.dataset.department = "";
      if (!employeeId) return;

      try {
        const resp = await fetch(`/api/employee/${employeeId}`);
        const text = await resp.text();
        console.log("ğŸ”§ [DEBUG] /api/employee å›æ‡‰åŸæ–‡:", text);
        let data = {};
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.warn("JSON è§£æå¤±æ•—");
        }
        if (resp.ok) {
          employeeInfoDisplay.textContent = `å§“å: ${data.name} / éƒ¨é–€: ${data.department}`;
          employeeInfoDisplay.dataset.name = data.name || "";
          employeeInfoDisplay.dataset.department = data.department || "";
        } else {
          employeeInfoDisplay.textContent = (data && data.detail) || "æŸ¥è©¢å¤±æ•—";
          employeeInfoDisplay.classList.add("error");
        }
      } catch (err) {
        console.error("ğŸ”§ [DEBUG] å–å“¡å·¥è³‡è¨Šå¤±æ•—:", err);
        employeeInfoDisplay.textContent = "æŸ¥è©¢æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤";
        employeeInfoDisplay.classList.add("error");
      }
    }
    employeeIdInput.addEventListener("blur", fetchEmployeeInfo);

    // é€å‡ºå‰æš«å­˜è³‡æ–™ï¼ˆä¾›æˆåŠŸå¾Œçµ„æ”¶æ“šï¼‰
    form.addEventListener("submit", function () {
      const items = [];
      form
        .querySelectorAll('.laundry-item input[type="number"]')
        .forEach((input) => {
          const quantity = parseInt(input.value || "0", 10);
          if (quantity > 0)
            items.push({
              name: input.previousElementSibling.innerText,
              quantity,
            });
        });

      const dataToStore = {
        employeeId: employeeIdInput.value,
        employeeName: employeeInfoDisplay.dataset.name || "",
        department: employeeInfoDisplay.dataset.department || "",
        date: document.getElementById("date").value,
        items,
      };
      console.log("ğŸ§¾ [DEBUG] é€å‡ºå‰å­˜å…¥ sessionStorage çš„è³‡æ–™:", dataToStore);
      sessionStorage.setItem("lastLaundryData", JSON.stringify(dataToStore));
    });

    // æˆåŠŸå›ä¾†å¾Œçµ„æ”¶æ“šï¼ˆæˆ– ?debug=1 å¼·åˆ¶é è¦½ï¼‰
    function buildReceiptFrom(data) {
      console.log("ğŸ§¾ [DEBUG] æ§‹å»ºé è¦½åˆ—å°è³‡æ–™:", data);
      // if (debugPre) debugPre.textContent = JSON.stringify(data, null, 2);

      if (!data || !Array.isArray(data.items) || data.items.length === 0) {
        printArea.innerHTML = `<p style="color:#d6336c">æ²’æœ‰å¯åˆ—å°çš„é …ç›®ï¼ˆitems ç‚ºç©ºï¼‰ã€‚</p>`;
        return;
      }
      let receiptHtml = `
      <h4>æ´—è¡£é€æ´—æ”¶æ“š</h4>
      <div class="print-info">
        <span><strong>éƒ¨é–€:</strong> ${data.department || "-"}</span>
        <span><strong>é€æ´—æ—¥æœŸ:</strong> ${data.date || "-"}</span>
      </div>
      <div class="print-info">
        <span><strong>å“¡å·¥:</strong> ${data.employeeName || "-"} (${
        data.employeeId || "-"
      })</span>
        <span></span>
      </div>
      <table>
        <thead><tr><th>é …ç›®</th><th>æ•¸é‡</th></tr></thead>
        <tbody>`;
      data.items.forEach((item) => {
        receiptHtml += `<tr><td>${item.name}</td><td>${item.quantity}</td></tr>`;
      });
      receiptHtml += `</tbody></table>`;
      printArea.innerHTML = receiptHtml;
    }

    const urlParams = new URLSearchParams(window.location.search);
    console.log(
      "ğŸ”§ [DEBUG] URL åƒæ•¸:",
      Object.fromEntries(urlParams.entries())
    );

    const stored = sessionStorage.getItem("lastLaundryData");
    console.log("ğŸ”§ [DEBUG] è®€åˆ° sessionStorage.lastLaundryData:", stored);

    if (urlParams.has("success") || urlParams.get("debug") === "1") {
      if (stored) {
        const data = JSON.parse(stored);
        buildReceiptFrom(data);
        modal.classList.remove("hidden");
        if (urlParams.has("success")) {
          sessionStorage.removeItem("lastLaundryData");
          history.replaceState(null, "", window.location.pathname);
        }
      } else {
        console.warn(
          "âš ï¸ [DEBUG] æ²’æœ‰ sessionStorage è³‡æ–™ï¼Œå¯èƒ½æ˜¯é‡æ–°æ•´ç†äº†é é¢æˆ–æäº¤å‰æœªå¯«å…¥ã€‚"
        );
      }
    } else {
      console.warn(
        "â„¹ï¸ [DEBUG] æ²’æœ‰ ?success åƒæ•¸ï¼Œé è¨­ä¸é¡¯ç¤ºé è¦½ã€‚è‹¥è¦æ¸¬è©¦å¯åœ¨ç¶²å€åŠ ä¸Š ?debug=1"
      );
    }

    /* ===================== åˆ—å°æµç¨‹ï¼šæŒ‰éˆ•æˆ– Ctrl+P éƒ½é©ç”¨ ===================== */
    function populatePrintRoot() {
      const html = printArea?.innerHTML?.trim() || "";
      console.log(
        "ğŸ–¨ï¸ [DEBUG] beforeprintï¼šprint-area æœ‰å…§å®¹å—ï¼Ÿ",
        !!html,
        "é•·åº¦:",
        html.length
      );

      if (!html) return;

      // è§£é™¤ä»»ä½• aria-hidden
      printRoot.setAttribute("aria-hidden", "false");

      // è¤‡è£½å…§å®¹
      printRoot.innerHTML = "";
      const clone = printArea.cloneNode(true);

      // é˜²æ­¢å¤–æ¡†æ¨£å¼å½±éŸ¿åˆ—å°
      clone.style.border = "none";
      clone.style.margin = "0";
      clone.style.padding = "0";

      printRoot.appendChild(clone);

      // é€²ä¸€æ­¥ logï¼šç¢ºèªåˆ—å°æ¨¹ç‹€ç¯€é»
      console.log(
        "ğŸ–¨ï¸ [DEBUG] å·²è¤‡è£½åˆ° print-rootã€‚ç¯€é»æ•¸ï¼š",
        printRoot.querySelectorAll("*").length,
        "è¡¨æ ¼åˆ—æ•¸ï¼š",
        printRoot.querySelectorAll("tr").length
      );

      // è‹¥ä»çœ‹ä¸åˆ°ï¼Œå¯è‡¨æ™‚åŠ ä¸€å€‹é‚Šç•Œæ–¹ä¾¿è‚‰çœ¼åˆ¤æ–·ï¼ˆæ¸¬å®Œå¯ç§»é™¤ï¼‰
      // printRoot.style.outline = "2px dashed red";
    }

    function printOnSamePage() {
      populatePrintRoot();
      if (!printRoot.innerHTML.trim()) {
        alert("æ²’æœ‰å¯åˆ—å°çš„å…§å®¹ã€‚è«‹å…ˆæäº¤ä¸€æ¬¡è¡¨å–®ç”¢ç”Ÿæ”¶æ“šã€‚");
        return;
      }
      window.print();
      cleanupAfterPrint();
    }
    if (printBtn) printBtn.addEventListener("click", printOnSamePage);

    // ç›´æ¥ Ctrl+Pï¼šç¢ºä¿å…§å®¹å·²è¤‡è£½
    window.addEventListener("beforeprint", populatePrintRoot);
    window.addEventListener("afterprint", cleanupAfterPrint);

    // å…¼å®¹æ€§ï¼šéƒ¨åˆ†ç€è¦½å™¨ç”¨åª’é«”æŸ¥è©¢
    const mq = window.matchMedia("print");
    if (mq && mq.addEventListener) {
      mq.addEventListener("change", (e) => {
        if (e.matches) populatePrintRoot();
        else cleanupAfterPrint();
      });
    }
    function closeModal() {
      modal.classList.add("hidden");
      modal.style.display = "none"; // ç¢ºä¿ç›´æ¥éš±è—
      form.reset();
      employeeInfoDisplay.textContent = "";
      employeeInfoDisplay.classList.remove("error");
    }

    // ç¶å®šæ‰€æœ‰é—œé–‰æŒ‰éˆ•
    closeModalBtns.forEach((btn) => {
      if (btn) btn.addEventListener("click", closeModal);
    });

    // å³ä¸Šè§’å‰å‰ä¹Ÿç”¨åŒæ¨£äº‹ä»¶ï¼ˆä¿éšªï¼‰
    document
      .getElementById("close-modal-btn")
      ?.addEventListener("click", closeModal);

    /* ======================================================================= */
  });
</script>
{% endblock %}
