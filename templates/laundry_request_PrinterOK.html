<!-- templates/laundry_request.html -->
{% extends "base.html" %} {% block title %}洗衣房送洗登記 - {{ super() }}{%
endblock %} {% block content %}
<div class="page-header">
  <h2>洗衣房送洗登記</h2>
</div>

{% if error %}
<div class="alert alert-danger"><strong>錯誤：</strong> {{ error }}</div>
{% endif %}

<div class="form-container card">
  <form id="laundry-form" action="/laundry/request" method="post">
    <div class="form-grid">
      <div class="form-group">
        <label for="date">送洗日期</label>
        <input type="date" id="date" name="date" value="{{ today }}" required />
      </div>
      <div class="form-group">
        <label for="employee_id">員工編號</label>
        <input
          type="text"
          id="employee_id"
          name="employee_id"
          placeholder="請輸入您的員工編號"
          required
        />
        <small id="employee-info" class="employee-info-display"></small>
      </div>
    </div>

    <hr />

    <h4>送洗項目與數量</h4>
    <div class="laundry-items-grid">
      {% for item in clothing_items %}
      <div class="laundry-item">
        <label for="quantity_{{ item }}">{{ item }}</label>
        <input
          type="number"
          id="quantity_{{ item }}"
          name="quantity_{{ item }}"
          min="0"
          value="0"
        />
      </div>
      {% endfor %}
    </div>

    <div class="form-actions">
      <button type="submit" class="button button-primary">提交登記</button>
    </div>
  </form>
</div>

<!-- 成功訊息彈出視窗 -->
<div id="success-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>✅ 資料已成功儲存！</h3>
      <button id="close-modal-btn" class="close-button">&times;</button>
    </div>
    <div class="modal-body">
      <p>您可以列印本次的送洗收據，或關閉此視窗以繼續登記。</p>
      <!-- 畫面顯示用的收據區塊（列印時會被複製到 #print-root） -->
      <div id="print-area"></div>
      <pre
        id="debug-json"
        style="
          background: #f8f9fa;
          border: 1px dashed #dee2e6;
          padding: 0.75rem;
          margin-top: 1rem;
          max-height: 220px;
          overflow: auto;
        "
      ></pre>
    </div>
    <div class="modal-footer">
      <button id="print-btn" class="button">🖨️ 列印收據</button>
      <button id="close-modal-footer-btn" class="button button-secondary">
        關閉
      </button>
    </div>
  </div>
</div>

<!-- 列印專用容器（平常隱藏，列印時只輸出這一塊） -->
<div id="print-root" aria-hidden="true"></div>

<style>
  .form-container {
    max-width: 900px;
    margin: 0 auto;
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .laundry-items-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 1rem;
  }
  .laundry-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f8f9fa;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e9ecef;
    transition: box-shadow 0.2s;
  }
  .laundry-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }
  .laundry-item input[type="number"] {
    width: 70px;
    text-align: center;
    padding: 0.375rem 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1rem;
  }
  .form-actions {
    margin-top: 25px;
    text-align: right;
  }
  .alert-danger {
    color: #721c24;
    background: #f8d7da;
    border-color: #f5c6cb;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 4px;
  }

  .employee-info-display {
    margin-top: 8px;
    padding: 8px 12px;
    background: #e9ecef;
    border-radius: 4px;
    color: #495057;
    font-weight: 500;
    min-height: 22px;
    border: 1px solid #ced4da;
  }
  .employee-info-display.error {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 1;
    transition: opacity 0.3s;
  }
  .modal-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }
  .modal-content {
    background: #fff;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 520px;
    transform: scale(1);
    transition: transform 0.3s;
  }
  .modal-overlay.hidden .modal-content {
    transform: scale(0.9);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
  }
  .close-button {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: #6c757d;
  }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
    margin-top: 1rem;
  }
  .button-secondary {
    background: #6c757d;
    color: #fff;
  }

  .modal-overlay.hidden {
    opacity: 0;
    pointer-events: none;
    display: none; /* 新增這行 */
  }

  /* 收據視覺樣式（畫面用） */
  #print-area {
    border: 1px dashed #adb5bd;
    padding: 1.5rem;
    margin-top: 1rem;
    font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial,
      sans-serif;
    background: #fff;
  }
  #print-area h4 {
    text-align: center;
    margin: 0 0 0.75rem 0;
  }
  #print-area .print-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
  }
  #print-area table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
    table-layout: fixed;
  }
  #print-area th,
  #print-area td {
    border: 1px solid #dee2e6;
    padding: 8px;
    text-align: left;
    word-break: break-all;
  }
  #print-area th {
    background: #f1f3f5;
  }

  /* ========= 列印：只輸出 #print-root，其他全隱藏 ========= */
  /* ========= 列印：只輸出 #print-root，其他以 visibility 隱藏 ========= */
  @media print {
    @page {
      margin: 12mm;
    }
    html,
    body {
      margin: 0 !important;
      padding: 0 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* 先把整頁隱藏，但不改變排版流，避免空白頁或還原失敗 */
    body * {
      visibility: hidden !important;
    }

    /* 只顯示 #print-root 與其子元素 */
    #print-root,
    #print-root * {
      visibility: visible !important;
    }

    /* 把 #print-root 放到頁面左上角鋪滿寬度，確保一定看得到 */
    #print-root {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      border: 0 !important;
      box-shadow: none !important;
      transform: none !important;
    }

    /* 避免表格被拆頁 */
    #print-root table {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    #print-root tr,
    #print-root td,
    #print-root th {
      page-break-inside: avoid;
      break-inside: avoid;
    }
  }

  @media (max-width: 768px) {
    .laundry-items-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 480px) {
    .laundry-items-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    console.log("🔧 [DEBUG] DOM 已就緒");
    const form = document.getElementById("laundry-form");
    const modal = document.getElementById("success-modal");
    const printBtn = document.getElementById("print-btn");
    const closeModalBtns = [
      document.getElementById("close-modal-btn"),
      document.getElementById("close-modal-footer-btn"),
    ];
    const printArea = document.getElementById("print-area");
    const printRoot = document.getElementById("print-root");
    const employeeIdInput = document.getElementById("employee_id");
    const employeeInfoDisplay = document.getElementById("employee-info");
    const debugPre = document.getElementById("debug-json");

    // 取得員工資訊（輸入框離開時）
    async function fetchEmployeeInfo() {
      const employeeId = employeeIdInput.value.trim();
      employeeInfoDisplay.textContent = "";
      employeeInfoDisplay.classList.remove("error");
      employeeInfoDisplay.dataset.name = "";
      employeeInfoDisplay.dataset.department = "";
      if (!employeeId) return;

      try {
        const resp = await fetch(`/api/employee/${employeeId}`);
        const text = await resp.text();
        console.log("🔧 [DEBUG] /api/employee 回應原文:", text);
        let data = {};
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.warn("JSON 解析失敗");
        }
        if (resp.ok) {
          employeeInfoDisplay.textContent = `姓名: ${data.name} / 部門: ${data.department}`;
          employeeInfoDisplay.dataset.name = data.name || "";
          employeeInfoDisplay.dataset.department = data.department || "";
        } else {
          employeeInfoDisplay.textContent = (data && data.detail) || "查詢失敗";
          employeeInfoDisplay.classList.add("error");
        }
      } catch (err) {
        console.error("🔧 [DEBUG] 取員工資訊失敗:", err);
        employeeInfoDisplay.textContent = "查詢時發生網路錯誤";
        employeeInfoDisplay.classList.add("error");
      }
    }
    employeeIdInput.addEventListener("blur", fetchEmployeeInfo);

    // 送出前暫存資料（供成功後組收據）
    form.addEventListener("submit", function () {
      const items = [];
      form
        .querySelectorAll('.laundry-item input[type="number"]')
        .forEach((input) => {
          const quantity = parseInt(input.value || "0", 10);
          if (quantity > 0)
            items.push({
              name: input.previousElementSibling.innerText,
              quantity,
            });
        });

      const dataToStore = {
        employeeId: employeeIdInput.value,
        employeeName: employeeInfoDisplay.dataset.name || "",
        department: employeeInfoDisplay.dataset.department || "",
        date: document.getElementById("date").value,
        items,
      };
      console.log("🧾 [DEBUG] 送出前存入 sessionStorage 的資料:", dataToStore);
      sessionStorage.setItem("lastLaundryData", JSON.stringify(dataToStore));
    });

    // 成功回來後組收據（或 ?debug=1 強制預覽）
    function buildReceiptFrom(data) {
      console.log("🧾 [DEBUG] 構建預覽列印資料:", data);
      // if (debugPre) debugPre.textContent = JSON.stringify(data, null, 2);

      if (!data || !Array.isArray(data.items) || data.items.length === 0) {
        printArea.innerHTML = `<p style="color:#d6336c">沒有可列印的項目（items 為空）。</p>`;
        return;
      }
      let receiptHtml = `
      <h4>洗衣送洗收據</h4>
      <div class="print-info">
        <span><strong>部門:</strong> ${data.department || "-"}</span>
        <span><strong>送洗日期:</strong> ${data.date || "-"}</span>
      </div>
      <div class="print-info">
        <span><strong>員工:</strong> ${data.employeeName || "-"} (${
        data.employeeId || "-"
      })</span>
        <span></span>
      </div>
      <table>
        <thead><tr><th>項目</th><th>數量</th></tr></thead>
        <tbody>`;
      data.items.forEach((item) => {
        receiptHtml += `<tr><td>${item.name}</td><td>${item.quantity}</td></tr>`;
      });
      receiptHtml += `</tbody></table>`;
      printArea.innerHTML = receiptHtml;
    }

    const urlParams = new URLSearchParams(window.location.search);
    console.log(
      "🔧 [DEBUG] URL 參數:",
      Object.fromEntries(urlParams.entries())
    );

    const stored = sessionStorage.getItem("lastLaundryData");
    console.log("🔧 [DEBUG] 讀到 sessionStorage.lastLaundryData:", stored);

    if (urlParams.has("success") || urlParams.get("debug") === "1") {
      if (stored) {
        const data = JSON.parse(stored);
        buildReceiptFrom(data);
        modal.classList.remove("hidden");
        if (urlParams.has("success")) {
          sessionStorage.removeItem("lastLaundryData");
          history.replaceState(null, "", window.location.pathname);
        }
      } else {
        console.warn(
          "⚠️ [DEBUG] 沒有 sessionStorage 資料，可能是重新整理了頁面或提交前未寫入。"
        );
      }
    } else {
      console.warn(
        "ℹ️ [DEBUG] 沒有 ?success 參數，預設不顯示預覽。若要測試可在網址加上 ?debug=1"
      );
    }

    /* ===================== 列印流程：按鈕或 Ctrl+P 都適用 ===================== */
    function populatePrintRoot() {
      const html = printArea?.innerHTML?.trim() || "";
      console.log(
        "🖨️ [DEBUG] beforeprint：print-area 有內容嗎？",
        !!html,
        "長度:",
        html.length
      );

      if (!html) return;

      // 解除任何 aria-hidden
      printRoot.setAttribute("aria-hidden", "false");

      // 複製內容
      printRoot.innerHTML = "";
      const clone = printArea.cloneNode(true);

      // 防止外框樣式影響列印
      clone.style.border = "none";
      clone.style.margin = "0";
      clone.style.padding = "0";

      printRoot.appendChild(clone);

      // 進一步 log：確認列印樹狀節點
      console.log(
        "🖨️ [DEBUG] 已複製到 print-root。節點數：",
        printRoot.querySelectorAll("*").length,
        "表格列數：",
        printRoot.querySelectorAll("tr").length
      );

      // 若仍看不到，可臨時加一個邊界方便肉眼判斷（測完可移除）
      // printRoot.style.outline = "2px dashed red";
    }

    function printOnSamePage() {
      populatePrintRoot();
      if (!printRoot.innerHTML.trim()) {
        alert("沒有可列印的內容。請先提交一次表單產生收據。");
        return;
      }
      window.print();
      cleanupAfterPrint();
    }
    if (printBtn) printBtn.addEventListener("click", printOnSamePage);

    // 直接 Ctrl+P：確保內容已複製
    window.addEventListener("beforeprint", populatePrintRoot);
    window.addEventListener("afterprint", cleanupAfterPrint);

    // 兼容性：部分瀏覽器用媒體查詢
    const mq = window.matchMedia("print");
    if (mq && mq.addEventListener) {
      mq.addEventListener("change", (e) => {
        if (e.matches) populatePrintRoot();
        else cleanupAfterPrint();
      });
    }
    function closeModal() {
      modal.classList.add("hidden");
      modal.style.display = "none"; // 確保直接隱藏
      form.reset();
      employeeInfoDisplay.textContent = "";
      employeeInfoDisplay.classList.remove("error");
    }

    // 綁定所有關閉按鈕
    closeModalBtns.forEach((btn) => {
      if (btn) btn.addEventListener("click", closeModal);
    });

    // 右上角叉叉也用同樣事件（保險）
    document
      .getElementById("close-modal-btn")
      ?.addEventListener("click", closeModal);

    /* ======================================================================= */
  });
</script>
{% endblock %}
