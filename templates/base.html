<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}OneTouch Portal{% endblock %}</title>
    <!-- ç¢ºä¿ä½¿ç”¨ url_for ä¾†ç”Ÿæˆéœæ…‹æª”æ¡ˆçš„è·¯å¾‘ -->
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', path='style.css') }}?v=20250821"
    />
    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <div class="app-container">
      <!-- å¼•å…¥å…±ç”¨çš„å°è¦½åˆ— -->
      {% if user %} {% include '_navbar.html' %} {% endif %}

      <main class="main-content">
        <header class="header">
          {% if user %}
          <div class="header-user-info">
            <span
              ><strong
                >ğŸ‘‹ æ­¡è¿å›ä¾†, {{ user }}!
                è«‹å¾å·¦å´çš„åŠŸèƒ½åˆ—é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„æœå‹™ã€‚</strong
              ></span
            >
          </div>
          {% endif %}
        </header>

        <div class="page-content">{% block content %}{% endblock %}</div>
      </main>
    </div>

    <!-- ===== æ›´æ–°å¾Œçš„ JavaScript å€å¡Š ===== -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const appContainer = document.querySelector(".app-container");
        const sidebarToggle = document.getElementById("sidebar-toggle");

        // --- å­é¸å–®é‚è¼¯ï¼šé»æ–°ä¸»é¸å–®æ™‚ï¼Œå…¶å®ƒè‡ªå‹•æ”¶èµ· ---
        const submenuToggles = document.querySelectorAll(
          ".sidebar .has-submenu > a"
        );
        submenuToggles.forEach(function (toggle) {
          toggle.addEventListener("click", function (event) {
            // å´é‚Šæ¬„è‹¥ç‚ºæ”¶åˆç‹€æ…‹å°±ä¸è™•ç†å±•é–‹
            if (appContainer.classList.contains("sidebar-collapsed")) {
              return;
            }
            event.preventDefault();
            const parentLi = this.parentElement;

            // å…ˆæŠŠã€Œå…¶å®ƒã€å·²å±•é–‹çš„ä¸»é¸å–®æ”¶èµ·ä¾†
            document
              .querySelectorAll(".sidebar .has-submenu.open")
              .forEach(function (li) {
                if (li !== parentLi) li.classList.remove("open");
              });

            // å†åˆ‡æ›ç•¶å‰ä¸»é¸å–®
            parentLi.classList.toggle("open");
          });
        });

        // è¼‰å…¥æ™‚è‹¥æœ‰å­é¸å–®é …ç›®æ˜¯ activeï¼Œè®“å…¶çˆ¶å±¤é è¨­å±•é–‹
        const activeSubmenuLink = document.querySelector(".submenu a.active");
        if (activeSubmenuLink) {
          const parentSubmenu = activeSubmenuLink.closest(".has-submenu");
          if (parentSubmenu) parentSubmenu.classList.add("open");
        }

        // --- å´é‚Šæ¬„æ”¶åˆé‚è¼¯ï¼ˆä¿ç•™ï¼‰ ---
        if (sidebarToggle) {
          // 1) è¼‰å…¥æ™‚å¥—ç”¨ localStorage ç‹€æ…‹
          if (localStorage.getItem("sidebarCollapsed") === "true") {
            appContainer.classList.add("sidebar-collapsed");
          }
          // 2) åˆ‡æ›æŒ‰éˆ•
          sidebarToggle.addEventListener("click", function (event) {
            event.preventDefault();
            appContainer.classList.toggle("sidebar-collapsed");
            // 3) å­˜å›ç‹€æ…‹
            const isCollapsed =
              appContainer.classList.contains("sidebar-collapsed");
            localStorage.setItem("sidebarCollapsed", isCollapsed);
          });
        }
      });
    </script>
    <!-- ================================ -->
  </body>
</html>
