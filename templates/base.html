<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}OneTouch Portal{% endblock %}</title>
    <!-- 確保使用 url_for 來生成靜態檔案的路徑 -->
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', path='style.css') }}?v=20250821"
    />
    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <div class="app-container">
      <!-- 引入共用的導覽列 -->
      {% if user %} {% include '_navbar.html' %} {% endif %}

      <main class="main-content">
        <header class="header">
          {% if user %}
          <div class="header-user-info">
            <span
              ><strong
                >👋 歡迎回來, {{ user }}!
                請從左側的功能列選擇您要使用的服務。</strong
              ></span
            >
          </div>
          {% endif %}
        </header>

        <div class="page-content">{% block content %}{% endblock %}</div>
      </main>
    </div>

    <!-- ===== 更新後的 JavaScript 區塊 ===== -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const appContainer = document.querySelector(".app-container");
        const sidebarToggle = document.getElementById("sidebar-toggle");

        // --- 子選單邏輯：點新主選單時，其它自動收起 ---
        const submenuToggles = document.querySelectorAll(
          ".sidebar .has-submenu > a"
        );
        submenuToggles.forEach(function (toggle) {
          toggle.addEventListener("click", function (event) {
            // 側邊欄若為收合狀態就不處理展開
            if (appContainer.classList.contains("sidebar-collapsed")) {
              return;
            }
            event.preventDefault();
            const parentLi = this.parentElement;

            // 先把「其它」已展開的主選單收起來
            document
              .querySelectorAll(".sidebar .has-submenu.open")
              .forEach(function (li) {
                if (li !== parentLi) li.classList.remove("open");
              });

            // 再切換當前主選單
            parentLi.classList.toggle("open");
          });
        });

        // 載入時若有子選單項目是 active，讓其父層預設展開
        const activeSubmenuLink = document.querySelector(".submenu a.active");
        if (activeSubmenuLink) {
          const parentSubmenu = activeSubmenuLink.closest(".has-submenu");
          if (parentSubmenu) parentSubmenu.classList.add("open");
        }

        // --- 側邊欄收合邏輯（保留） ---
        if (sidebarToggle) {
          // 1) 載入時套用 localStorage 狀態
          if (localStorage.getItem("sidebarCollapsed") === "true") {
            appContainer.classList.add("sidebar-collapsed");
          }
          // 2) 切換按鈕
          sidebarToggle.addEventListener("click", function (event) {
            event.preventDefault();
            appContainer.classList.toggle("sidebar-collapsed");
            // 3) 存回狀態
            const isCollapsed =
              appContainer.classList.contains("sidebar-collapsed");
            localStorage.setItem("sidebarCollapsed", isCollapsed);
          });
        }
      });
    </script>
    <!-- ================================ -->
  </body>
</html>
