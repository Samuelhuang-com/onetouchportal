<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}OneTouch Portal{% endblock %}</title>
    <!-- 確保使用 url_for 來生成靜態檔案的路徑 -->
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="app-container">
      <!-- 引入共用的導覽列 -->
      {% if user %} {% include '_navbar.html' %} {% endif %}

      <main class="main-content">
        <header class="header">
          <!--div class="header-left">
            <img
              src="{{ url_for('static', path='logo.png') }}"
              alt="Logo"
              class="logo"
            />
            <strong>OneTouch Portal</strong>
          <div-->
          <!-- 我們將原本右側的資訊移到這裡，並移除連結 -->
          {% if user %}
          <div class="header-user-info">
            <!-- span>歡迎, {{ user }} ({{role}})</span-->
            <span><strong>👋 歡迎回來, {{ user }}! 請從左側的功能列選擇您要使用的服務。</strong></span>
            
</p>
          </div>
          {% endif %}
        </header>

        <div class="page-content">
          <!-- 這裡是子模板內容的插入點 -->
          {% block content %}{% endblock %}
        </div>
      </main>
    </div>
    <!-- ===== 更新後的 JavaScript 區塊 ===== -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const appContainer = document.querySelector(".app-container");
        const sidebarToggle = document.getElementById("sidebar-toggle");

        // --- 子選單邏輯 (保留) ---
        const submenuToggles = document.querySelectorAll(
          ".sidebar .has-submenu > a"
        );
        submenuToggles.forEach(function (toggle) {
          toggle.addEventListener("click", function (event) {
            // 如果側邊欄是收合的，就不要執行子選單的展開動作
            if (appContainer.classList.contains("sidebar-collapsed")) {
              return;
            }
            event.preventDefault();
            const parentLi = this.parentElement;
            parentLi.classList.toggle("open");
          });
        });

        const activeSubmenuLink = document.querySelector(".submenu a.active");
        if (activeSubmenuLink) {
          const parentSubmenu = activeSubmenuLink.closest(".has-submenu");
          if (parentSubmenu) {
            parentSubmenu.classList.add("open");
          }
        }

        // --- 側邊欄收合邏輯 (新增) ---
        if (sidebarToggle) {
          // 1. 頁面載入時，檢查 localStorage 是否有已存的狀態
          if (localStorage.getItem("sidebarCollapsed") === "true") {
            appContainer.classList.add("sidebar-collapsed");
          }

          // 2. 監聽按鈕點擊
          sidebarToggle.addEventListener("click", function (event) {
            event.preventDefault();
            appContainer.classList.toggle("sidebar-collapsed");

            // 3. 將新狀態存入 localStorage
            const isCollapsed =
              appContainer.classList.contains("sidebar-collapsed");
            localStorage.setItem("sidebarCollapsed", isCollapsed);
          });
        }
      });
    </script>
    <!-- ================================ -->
  </body>
</html>
