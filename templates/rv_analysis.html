{% extends "base.html" %} {% block title %}ç‡Ÿæ”¶èˆ‡å…¥ä½ç‡æ³¢å‹•åˆ†æ - {{ super()
}}{% endblock %} {% block content %}
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  .grid {
    display: grid;
    grid-template-columns: 1.4fr 0.6fr;
    gap: 1rem;
  }
  .card {
    background: #fff;
    border-radius: 12px;
    padding: 1rem 1.2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }
  .muted {
    color: #6c757d;
    font-size: 0.9rem;
  }
  .kpi-table {
    width: 100%;
    border-collapse: collapse;
  }
  .kpi-table th,
  .kpi-table td {
    border-bottom: 1px solid #eee;
    padding: 0.5rem 0.4rem;
    text-align: right;
  }
  .kpi-table th:first-child,
  .kpi-table td:first-child {
    text-align: left;
  }
  .tag {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    background: #f1f3f5;
    margin-right: 0.4rem;
    font-size: 0.85rem;
  }
  .bad {
    background: #ffe3e3;
  }
  .good {
    background: #e6fcf5;
  }
  .hint {
    font-size: 0.9rem;
    line-height: 1.6;
  }
  .title-row {
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
</style>

<div class="title-row">
  <h2>ğŸ“ˆ ç‡Ÿæ”¶èˆ‡å…¥ä½ç‡æ³¢å‹•åˆ†æ</h2>
  {% if src_file %}<span class="tag">ä¾†æºï¼š{{ src_file }}</span>{% endif %} {%
  if date_from and date_to %}<span class="tag"
    >æœŸé–“ï¼š{{ date_from }} ~ {{ date_to }}</span
  >{% endif %}
</div>

{% if error %}
<div class="card"><p style="color: #c92a2a">âš ï¸ {{ error }}</p></div>
{% else %}
<div class="grid">
  <div class="card">
    <h3>æ¯æ—¥æŒ‡æ¨™è¶¨å‹¢</h3>
    <canvas id="trendChart" height="140"></canvas>
    <p class="muted">
      é¡è‰²ï¼šç‡Ÿæ”¶ / å…¥ä½ç‡ / ADR / RevPARï¼ˆåŒè»¸ï¼šæ”¶å…¥é¡ï¼›å…¥ä½ç‡å¦è»¸ï¼Œå–®ä½%ï¼‰ã€‚
    </p>
  </div>

  <div class="card">
    <h3>æ•´é«”ç‡Ÿé‹æ‘˜è¦</h3>
    <table class="kpi-table">
      <thead>
        <tr>
          <th>æŒ‡æ¨™</th>
          <th>å¹³å‡å€¼</th>
          <th>æœ€é«˜</th>
          <th>æœ€ä½</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>ç¸½ç‡Ÿæ”¶ (NT$)</td>
          <td>{{ summary.revenue.avg | round(0) | int | number }}</td>
          <td>{{ summary.revenue.max | round(0) | int | number }}</td>
          <td>{{ summary.revenue.min | round(0) | int | number }}</td>
        </tr>
        <tr>
          <td>å…¥ä½ç‡ (%)</td>
          <td>{{ summary.occ.avg | round(2) }}</td>
          <td>{{ summary.occ.max | round(2) }}</td>
          <td>{{ summary.occ.min | round(2) }}</td>
        </tr>
        <tr>
          <td>ADR (NT$)</td>
          <td>{{ summary.adr.avg | round(0) | int | number }}</td>
          <td>{{ summary.adr.max | round(0) | int | number }}</td>
          <td>{{ summary.adr.min | round(0) | int | number }}</td>
        </tr>
        <tr>
          <td>RevPAR (NT$)</td>
          <td>{{ summary.revpar.avg | round(0) | int | number }}</td>
          <td>{{ summary.revpar.max | round(0) | int | number }}</td>
          <td>{{ summary.revpar.min | round(0) | int | number }}</td>
        </tr>
      </tbody>
    </table>
    <div class="muted" style="margin-top: 0.6rem">
      è®Šç•°(Std)ï¼šç‡Ÿæ”¶ {{ summary.revenue.std | round(0) | int | number }}ã€
      å…¥ä½ç‡ {{ summary.occ.std | round(2) }}ã€ ADR {{ summary.adr.std |
      round(0) | int | number }}ã€ RevPAR {{ summary.revpar.std | round(0) | int
      | number }}
    </div>
  </div>
</div>

<div class="card" style="margin-top: 1rem">
  <h3>åˆ†æèˆ‡æ´å¯Ÿ</h3>
  <div class="hint">
    {% if insight.start_date %}
    <p>
      ğŸ“Œ æœ‰æ•ˆç‡Ÿé‹èµ·è·‘æ—¥ï¼šç´„å¾
      <strong>{{ insight.start_date }}</strong> é–‹å§‹å››å¤§æŒ‡æ¨™æ˜é¡¯è½‰æ­£ã€‚
    </p>
    {% endif %}
    <p>
      ğŸ“ˆ ç‡Ÿæ”¶å°–å³°ï¼š{% if insight.peaks_dips.revenue.peaks %}{% for d in
      insight.peaks_dips.revenue.peaks %}<span class="tag good">{{ d }}</span>{%
      endfor %}{% else %}â€”{% endif %}
    </p>
    <p>
      ğŸ“‰ ç‡Ÿæ”¶ä½è°·ï¼š{% if insight.peaks_dips.revenue.dips %}{% for d in
      insight.peaks_dips.revenue.dips %}<span class="tag bad">{{ d }}</span>{%
      endfor %}{% else %}â€”{% endif %}
    </p>
    <p>
      ğŸ¨ å…¥ä½ç‡é«˜é»ï¼š{% if insight.peaks_dips.occ.peaks %}{% for d in
      insight.peaks_dips.occ.peaks %}<span class="tag good">{{ d }}</span>{%
      endfor %}{% else %}â€”{% endif %}
    </p>
    <p>
      ğŸ•³ï¸ å…¥ä½ç‡ä½é»ï¼š{% if insight.peaks_dips.occ.dips %}{% for d in
      insight.peaks_dips.occ.dips %}<span class="tag bad">{{ d }}</span>{%
      endfor %}{% else %}â€”{% endif %}
    </p>
    <hr />
    <ul>
      <li>
        å¹³æ—¥ vs å‡æ—¥ç­–ç•¥ï¼šé‡å°ä½å…¥ä½ç‡æ—¥ï¼Œå„ªå…ˆä»¥åŠ å€¼ï¼ˆæ—©é¤å‡ç´šã€å»¶é€€ï¼‰ç¶­æŒ
        ADRï¼Œå†è¦–éœ€æ±‚å¾®èª¿åƒ¹ã€‚
      </li>
      <li>
        é«˜éœ€æ±‚æ—¥ï¼ˆå°–å³°ï¼‰ï¼šå»ºè­°ææ—©åŠ åƒ¹èˆ‡è¨­ç½®é™åˆ¶ï¼ˆæœ€å°‘å…¥ä½æ™šæ•¸ã€æå‰å¤©æ•¸è¨‚é‡‘ï¼‰ã€‚
      </li>
      <li>é—œæ³¨ RevPARï¼šä»¥ RevPAR æœ€å¤§åŒ–ç‚ºç›®æ¨™å¹³è¡¡ã€Œå…¥ä½ç‡ Ã— ADRã€ã€‚</li>
    </ul>
  </div>
</div>

<script>
  const labels = {{ chart_labels | tojson }};
  const dsRevenue = {{ chart_data.revenue | tojson }};
  const dsOcc = {{ chart_data.occ | tojson }};
  const dsADR = {{ chart_data.adr | tojson }};
  const dsRevPAR = {{ chart_data.revpar | tojson }};

  const ctx = document.getElementById('trendChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {label:'ç¸½ç‡Ÿæ”¶', data: dsRevenue, yAxisID:'y1', tension: 0.25},
        {label:'å…¥ä½ç‡(%)', data: dsOcc, yAxisID:'y2', tension: 0.25},
        {label:'ADR', data: dsADR, yAxisID:'y1', tension: 0.25},
        {label:'RevPAR', data: dsRevPAR, yAxisID:'y1', tension: 0.25}
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y1: { type:'linear', position:'left', title:{display:true, text:'é‡‘é¡ (NT$)'}},
        y2: { type:'linear', position:'right', title:{display:true, text:'å…¥ä½ç‡ (%)'}, min: 0, max: 100, grid:{drawOnChartArea:false} },
        x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 14 } }
      },
      plugins: {
        legend: { position: 'top' },
        tooltip: { callbacks: {
          label: (ctx) => {
            const label = ctx.dataset.label || '';
            const v = ctx.parsed.y ?? 0;
            if (label.includes('å…¥ä½ç‡')) return `${label}: ${v.toFixed(2)}%`;
            return `${label}: ${Math.round(v).toLocaleString('zh-TW')}`;
          }
        }}
      }
    }
  });
</script>
{% endif %} {% endblock %}
