{% extends "base.html" %} {% block title %}Excel 分析統計（MSR02） - {{ super()
}}{% endblock %} {% block content %}
<div class="page-header">
  <h2>Excel 分析統計（MSR02）</h2>
  <div class="filters">
    <label>開始日期 <input type="date" id="startDate" /></label>
    <label>結束日期 <input type="date" id="endDate" /></label>
    <button id="applyBtn" class="button">套用</button>
  </div>
</div>

{% if error %}
<div class="alert alert-error">⚠️ {{ error }}</div>
{% endif %}

<div class="kpi-grid">
  <div class="kpi">
    <div class="kpi-title">期間</div>
    <div class="kpi-value">
      <span id="kPeriod"
        >{{ kpi.period_start if kpi else '' }} ~ {{ kpi.period_end if kpi else
        '' }}</span
      >
    </div>
  </div>
  <div class="kpi">
    <div class="kpi-title">收入</div>
    <div class="kpi-value">
      ＄<span id="kRevenue"
        >{{ kpi.room_revenue | number if kpi else '0' }}</span
      >
    </div>
    <div class="kpi-sub">房租收入</div>
  </div>
  <div class="kpi">
    <div class="kpi-title">住房率</div>
    <div class="kpi-value">
      <span id="kOcc">{{ (kpi.occ_rate)|percent if kpi else '0%' }}</span>
    </div>
    <div class="kpi-sub">= 售房合計 / 可售房數</div>
  </div>
  <div class="kpi">
    <div class="kpi-title">ADR</div>
    <div class="kpi-value">
      ＄<span id="kADR">{{ (kpi.adr)|round(0) if kpi else '0' }}</span>
    </div>
    <div class="kpi-sub">= 房租 / 售房</div>
  </div>
  <div class="kpi">
    <div class="kpi-title">RevPAR</div>
    <div class="kpi-value">
      ＄<span id="kRevPAR">{{ (kpi.revpar)|round(0) if kpi else '0' }}</span>
    </div>
    <div class="kpi-sub">= 房租 / 可售房</div>
  </div>
  <div class="kpi">
    <div class="kpi-title">OOO 率</div>
    <div class="kpi-value">
      <span id="kOOO">{{ (kpi.ooo_rate)|percent if kpi else '0%' }}</span>
    </div>
    <div class="kpi-sub">= OOO / 總房間數</div>
  </div>
  <div class="kpi">
    <div class="kpi-title">FIT / GIT</div>
    <div class="kpi-value">
      <span id="kFIT">{{ kpi.fit if kpi else 0 }}</span> /
      <span id="kGIT">{{ kpi.git if kpi else 0 }}</span>
    </div>
    <div class="kpi-sub">人次合計</div>
  </div>
</div>

<div class="chart-grid">
  <div class="card">
    <h3>住房率（%）</h3>
    <canvas id="occChart"></canvas>
  </div>
  <div class="card">
    <h3>ADR</h3>
    <canvas id="adrChart"></canvas>
  </div>
  <div class="card">
    <h3>RevPAR</h3>
    <canvas id="revparChart"></canvas>
  </div>
  <div class="card">
    <h3>房租收入</h3>
    <canvas id="revChart"></canvas>
  </div>
  <div class="card">
    <h3>可售房 / 售房</h3>
    <canvas id="roomChart"></canvas>
  </div>
  <div class="card">
    <h3>FIT vs GIT</h3>
    <canvas id="fitgitChart"></canvas>
  </div>
</div>

<style>
  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .filters label {
    margin-right: 0.5rem;
  }
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(6, minmax(180px, 1fr));
    gap: 12px;
    margin: 10px 0 20px;
  }
  .kpi {
    background: var(--card-bg, #fff);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  }
  .kpi-title {
    font-size: 0.9rem;
    color: #777;
  }
  .kpi-value {
    font-size: 1.6rem;
    font-weight: 700;
    margin-top: 6px;
  }
  .kpi-sub {
    font-size: 0.8rem;
    color: #999;
  }
  .chart-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(280px, 1fr));
    gap: 16px;
  }
  .card {
    background: var(--card-bg, #fff);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  }
  @media (max-width: 960px) {
    .kpi-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const $ = (sel) => document.querySelector(sel);

  async function loadData() {
    const s = $("#startDate").value;
    const e = $("#endDate").value;
    const qs = new URLSearchParams();
    if (s) qs.set("start", s);
    if (e) qs.set("end", e);
    const res = await fetch(
      "/excel/analysis/data" + (qs.toString() ? "?" + qs.toString() : "")
    );
    const data = await res.json();
    // KPI
    const k = data.kpi || {};
    $("#kPeriod").textContent = (s || "") + (s || e ? " ~ " : "") + (e || "");
    $("#kRevenue").textContent = Math.round(
      k.room_revenue || 0
    ).toLocaleString();
    $("#kOcc").textContent = ((k.occ_rate || 0) * 100).toFixed(2) + "%";
    $("#kADR").textContent = (k.adr || 0).toFixed(0);
    $("#kRevPAR").textContent = (k.revpar || 0).toFixed(0);
    $("#kOOO").textContent = ((k.ooo_rate || 0) * 100).toFixed(2) + "%";
    $("#kFIT").textContent = k.fit || 0;
    $("#kGIT").textContent = k.git || 0;

    // Charts
    renderLine("occChart", data.dates, data.occ_rate, "住房率（%）");
    renderLine("adrChart", data.dates, data.adr, "ADR");
    renderLine("revparChart", data.dates, data.revpar, "RevPAR");
    renderBar("revChart", data.dates, data.revenue, "房租收入");
    renderBars("roomChart", data.dates, [
      { label: "可售房", data: data.rooms_available },
      { label: "售房", data: data.rooms_sold },
    ]);
    renderBars("fitgitChart", data.dates, [
      { label: "FIT", data: data.fit },
      { label: "GIT", data: data.git },
    ]);
  }

  let chartRefs = {};
  function destroyIfExists(id) {
    if (chartRefs[id]) {
      chartRefs[id].destroy();
      chartRefs[id] = null;
    }
  }

  function renderLine(id, labels, series, label) {
    destroyIfExists(id);
    const ctx = document.getElementById(id);
    chartRefs[id] = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{ label, data: series, tension: 0.25, fill: false }],
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } },
      },
    });
  }

  function renderBar(id, labels, series, label) {
    destroyIfExists(id);
    const ctx = document.getElementById(id);
    chartRefs[id] = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ label: label || "", data: series }] },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } },
      },
    });
  }

  function renderBars(id, labels, datasets) {
    destroyIfExists(id);
    const ctx = document.getElementById(id);
    chartRefs[id] = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
      },
    });
  }

  $("#applyBtn").addEventListener("click", loadData);
  window.addEventListener("load", loadData);
</script>
{% endblock %}
